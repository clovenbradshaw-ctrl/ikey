<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iKey App</title>
    <style>
    :root {
      --top-bar-height: 0px;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
      .top-bar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: white;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 20px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        z-index: 1000;
      }
      .lang-select {
        position: relative;
      }
      .lang-button {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 6px 10px;
        cursor: pointer;
        font-size: 0.875rem;
        direction: ltr;
      }
      .lang-dropdown {
        position: absolute;
        right: 0;
        top: 100%;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        margin-top: 4px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        display: none;
        max-height: 300px;
        overflow-y: auto;
        min-width: 160px;
        z-index: 1000;
        direction: ltr;
        text-align: left;
      }
      .lang-option {
        padding: 8px 12px;
        cursor: pointer;
        white-space: nowrap;
      }
      .lang-option:hover,
      .lang-option.active {
        background: #f0f0f0;
      }
      main {
        padding-top: var(--top-bar-height);
        scroll-margin-top: var(--top-bar-height);
      }
    </style>
  </head>
  <body>
    <div class="top-bar">
      <div class="logo">iKey</div>
      <div class="lang-select">
        <button class="lang-button" onclick="toggleLangDropdown()"><span id="current-language">EN</span> ‚ñº</button>
        <div class="lang-dropdown">
          <div class="lang-option" data-lang="en" dir="auto">EN English</div>
          <div class="lang-option" data-lang="es" dir="auto">ES Espa√±ol</div>
          <div class="lang-option" data-lang="ar" dir="auto">AR ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</div>
          <div class="lang-option" data-lang="ku" dir="auto">KU ⁄©Ÿàÿ±ÿØ€å</div>
        </div>
      </div>
    </div>
    <main class="main">
      <h1>Welcome to iKey</h1>
      <p>Your secure information vault.</p>
    </main>
  <script>
    function updateTopBarOffset() {
      const topBar = document.querySelector('.top-bar');
      const height = topBar ? topBar.offsetHeight : 0;
      document.documentElement.style.setProperty('--top-bar-height', height + 'px');
    }
      window.addEventListener('load', updateTopBarOffset);
      window.addEventListener('resize', updateTopBarOffset);
    </script>

<script src="vendor/qrcode.min.js"></script>
<script>window.QRCode || document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"><\/script>');</script>
<script src="vendor/jsQR.min.js"></script>
<script>window.jsQR || document.write('<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"><\/script>');</script>
<script src="text-size.js"></script>
<script src="medication.js"></script>
<script src="app.js"></script>
<script src="form-init.js"></script>

<script>
        // Configuration
        const VIEWER_URL = 'https://clovenbradshaw-ctrl.github.io/ikey/';
        const BEACON_TEXT = 'SQR:1';
        const WEBHOOK_URL = 'https://n8n.intelechia.com/webhook/d5e99c29-2cf1-44c1-b5b4-95a1ca048441';
        const XANO_BASE = 'https://xvkq-pq7i-idtl.n7d.xano.io/api:Hj4C6PGO';
        const MANUAL_AUTH_OVERRIDE = "YOUR_MANUAL_AUTH_KEY_HERE";
        const ARCHIVE_BASE = 'https://archive.org/download/zuboff/';

        const LANGUAGE_NAMES = {
          en: 'English',
          es: 'Espa√±ol',
          ar: 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©',
          ku: '⁄©Ÿàÿ±ÿØ€å',
          vi: 'Ti·∫øng Vi·ªát',
          zh: '‰∏≠Êñá',
          so: 'Soomaali',
          my: '·Äô·Äº·Äî·Ä∫·Äô·Ä¨',
          ne: '‡§®‡•á‡§™‡§æ‡§≤‡•Ä',
          am: '·ä†·àõ·à≠·äõ',
          bn: '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ',
          de: 'Deutsch',
          el: 'ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨',
          fa: 'ŸÅÿßÿ±ÿ≥€å',
          fr: 'Fran√ßais',
          gu: '‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä',
          he: '◊¢◊ë◊®◊ô◊™',
          hi: '‡§π‡§ø‡§®‡•ç‡§¶‡•Ä',
          ht: 'Krey√≤l Ayisyen',
          it: 'Italiano',
          ja: 'Êó•Êú¨Ë™û',
          ko: 'ÌïúÍµ≠Ïñ¥',
          lo: '‡∫•‡∫≤‡∫ß',
          pa: '‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä',
          pl: 'Polski',
          pt: 'Portugu√™s',
          ru: '–†—É—Å—Å–∫–∏–π',
          sw: 'Kiswahili',
          ta: '‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç',
          te: '‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å',
          th: '‡πÑ‡∏ó‡∏¢',
          tl: 'Tagalog',
          tr: 'T√ºrk√ße',
          uk: '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞',
          ur: 'ÿßÿ±ÿØŸà'
        };

        const PRIMARY_LANGS = ['en', 'es', 'ar', 'ku'];
        const RTL_LANGS = ['ar', 'ku', 'fa', 'he', 'ur'];

        let translations = {};

        let currentLanguage = 'en';

        function getRecordOrder(record) {
            if (!record) return 0;
            if (typeof record.id !== 'undefined') {
                return Number(record.id) || 0;
            }
            if (record.updated_at) {
                return new Date(record.updated_at).getTime();
            }
            if (record.created_at) {
                return new Date(record.created_at).getTime();
            }
            return 0;
        }

        function createLangButton(code) {
          const item = document.createElement('div');
          item.className = 'lang-option';
          item.dataset.lang = code;
          item.textContent = `${code.toUpperCase()} ${LANGUAGE_NAMES[code] || code}`;
          item.setAttribute('dir', 'auto');
          item.addEventListener('click', () => {
            setLanguage(code);
            toggleLangDropdown(false);
          });
          return item;
        }

        function buildLanguageButtons() {
          const dropdown = document.querySelector('.lang-dropdown');
          if (!dropdown) return;
          const existing = Array.from(dropdown.querySelectorAll('.lang-option')).map(el => el.dataset.lang);
          Object.keys(translations).forEach(code => {
            if (!existing.includes(code)) {
              dropdown.appendChild(createLangButton(code));
            }
          });
        }

        function attachLangHandlers() {
          document.querySelectorAll('.lang-option').forEach(el => {
            el.addEventListener('click', () => {
              setLanguage(el.dataset.lang);
              toggleLangDropdown(false);
            });
          });
        }

        function setLanguage(langCode) {
          currentLanguage = langCode;
          localStorage.setItem('ikey_preferred_language', langCode);

          document.documentElement.lang = langCode;
          document.documentElement.dir = RTL_LANGS.includes(langCode) ? 'rtl' : 'ltr';

          const t = translations[langCode] || translations.en || {};
          document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (t[key]) el.textContent = t[key];
          });
          document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
            const key = el.getAttribute('data-i18n-placeholder');
            if (t[key]) el.placeholder = t[key];
          });

          document.body.classList.toggle('rtl', RTL_LANGS.includes(langCode));

          document.getElementById('current-language').textContent = langCode.toUpperCase();
          document.querySelectorAll('.lang-option').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.lang === langCode);
          });
        }

        function toggleLangDropdown(force) {
          const dropdown = document.querySelector('.lang-dropdown');
          if (!dropdown) return;
          const shouldShow = force !== undefined ? force : dropdown.style.display !== 'block';
          dropdown.style.display = shouldShow ? 'block' : 'none';
        }

        document.addEventListener('click', function(e) {
          const dropdown = document.querySelector('.lang-dropdown');
          const button = document.querySelector('.lang-button');
          if (!dropdown || !button) return;
          if (!dropdown.contains(e.target) && !button.contains(e.target)) {
            dropdown.style.display = 'none';
          }
        });

        async function loadTranslations() {
          try {
            const response = await fetch('translations.json');
            const data = await response.json();
            const newTranslations = data.translations || data;
            Object.assign(translations, newTranslations);
            buildLanguageButtons();
            setLanguage(currentLanguage);
          } catch (error) {
            console.error('Failed to load translations:', error);
          }
        }

        // State
        let currentGUID = null;
        let currentKey = null;
        let currentData = null; // {encrypted, version, data}
        let currentBlob = null; // decrypted full data
        let currentSource = '';
        let currentMode = null;
        let ownerPassword = null;
        let uploadCheckInterval = null;
        let sessionTimeoutHandle = null;
        const SESSION_DURATION = 15 * 60 * 1000;

        async function parseAndDisplay() {
            const hash = window.location.hash.substring(1);

            // Handle legacy query style like /#app?f=create1
            if (hash.startsWith('app?')) {
                const params = new URLSearchParams(hash.slice(4));
                const route = params.get('f');
                if (route === 'bulk') {
                    window.location.href = 'bulk.html';
                    return;
                }
                currentMode = 'create';
                showCreationForm();
                return;
            }


            // Handle new app routes like /#app#create or /#app#bulk
            if (hash.startsWith('app#')) {
                const route = hash.split('#')[1];
                if (route === 'bulk') {
                    window.location.href = 'bulk.html';
                    return;
                }
                currentMode = 'create';
                showCreationForm();
                return;
            }

            if (!hash) {
                currentMode = 'create';
                showCreationForm();
                return;
            }

            if (hash.includes('|')) {
                const parts = hash.split('|').map(decodeURIComponent);
                if (parts.length >= 4) {
                    const [guid, key, name, created] = parts;
                    currentGUID = guid;
                    currentKey = key;
                    currentMode = 'view';
                    await loadAndDisplayEmergencyInfo(guid, key, name, created);
                } else {
                    handleLegacyFormat(hash);
                }
                return;
            }

            if (hash.startsWith('v2:')) {
                const [version, guid, key] = hash.split(':');
                currentGUID = guid;
                currentKey = key;
                currentMode = 'view';
                await loadAndDisplayEmergencyInfo(guid, key, null, null);
                return;
            }

            currentMode = 'create';
            showCreationForm();
        }

        async function displayFullInfo(full) {
            currentBlob = full;
            await displayEmergencyInfo(full);
            updateSourceLabel();
        }

        function buildUploadMessage() {
            return '‚è≥ Data still uploading... (usually ready in 5-30 min)';
        }

        function addOfflineNotice() {
            const el = document.getElementById('loading-message');
            if (el) el.textContent = buildUploadMessage();
            if (!uploadCheckInterval) {
                startUploadStatusPolling();
            }
        }

        function startUploadStatusPolling() {
            uploadCheckInterval = setInterval(async () => {
                try {
                    const full = await fetchFromArchive(currentGUID, currentKey);
                    clearInterval(uploadCheckInterval);
                    uploadCheckInterval = null;
                    await displayFullInfo(full);
                } catch (error) {
                    const el = document.getElementById('loading-message');
                    if (el) el.textContent = buildUploadMessage();
                }
            }, 10000);
        }

        function handleLegacyFormat(hash) {
            const parts = hash.split('|');
            if (parts.length === 3) {
                const [guid, key, dataStr] = parts;
                loadEmergencyInfo(guid, key, dataStr);
            } else {
                currentMode = 'create';
                showCreationForm();
            }
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', async function() {
            attachLangHandlers();
            loadTranslations();

            const savedLang =
                localStorage.getItem('ikey_preferred_language') ||
                navigator.language.substring(0, 2) ||
                'en';
            setLanguage(savedLang);

            await parseAndDisplay();

            const storedPassword = sessionStorage.getItem('ownerPassword');
            if (storedPassword) {
                const expiry = parseInt(sessionStorage.getItem('ownerSessionExpires'), 10);
                if (expiry && expiry > Date.now()) {
                    ownerPassword = storedPassword;
                    document.querySelector('.login-btn').style.display = 'none';
                    document.querySelector('.dashboard-btn').style.display = 'inline-block';
                    document.querySelector('.logout-btn').style.display = 'inline-block';
                    document.querySelector('.notes-tab-btn').style.display = 'inline-block';
                    document.querySelector('.health-records-btn').style.display = 'inline-block';
                    showOwnerDashboard();
                    startSessionTimer(expiry - Date.now());
                } else {
                    sessionStorage.removeItem('ownerPassword');
                    sessionStorage.removeItem('ownerSessionExpires');
                }
            }
        });

        async function loadEmergencyInfo(guid, key, permanentDataStr) {
            currentGUID = guid;
            currentKey = key;

            const permanentData = JSON.parse(atob(permanentDataStr));
            const displayData = {
                name: permanentData.n,
                bloodType: permanentData.b,
                allergies: permanentData.a,
                medications: permanentData.m,
                contact: (permanentData.cn || permanentData.cp)
                    ? { name: permanentData.cn || '', phone: permanentData.cp || '' }
                    : null
            };

            currentBlob = { publicInfo: displayData };
            await displayEmergencyInfo(currentBlob);

            try {
                let archiveData;
                let source = '';
                const cache = await fetchFromCache(guid);
                if (cache) {
                    archiveData = cache;
                    source = 'Server cache';
                } else {
                    const response = await fetch(
                        `${ARCHIVE_BASE}${guid}.json?ts=${Date.now()}`,
                        { mode: 'cors', cache: 'no-store' }
                    );
                    if (!response.ok) throw new Error('Not found');
                    archiveData = await response.json();
                    source = 'Archive.org';
                }
                currentSource = source;
                const decrypted = await decrypt(archiveData.editable, key);
                const editableFields = JSON.parse(decrypted);
                if (editableFields.publicInfo) {
                    const pub = editableFields.publicInfo;
                    if (pub.bloodType) displayData.bloodType = displayData.bloodType || pub.bloodType;
                    if (pub.allergies) displayData.allergies = displayData.allergies || pub.allergies;
                    if (pub.medications) displayData.medications = displayData.medications || pub.medications;
                    if (pub.contact) {
                        displayData.contact = pub.contact;
                    }
                    if (pub.secondaryContact) {
                        displayData.secondaryContact = pub.secondaryContact;
                    }
                } else {
                    if (editableFields.bloodType) displayData.bloodType = displayData.bloodType || editableFields.bloodType;
                    if (editableFields.allergies) displayData.allergies = displayData.allergies || editableFields.allergies;
                    if (editableFields.contactName || editableFields.contactPhone) {
                        displayData.contact = displayData.contact || {};
                        if (editableFields.contactName) displayData.contact.name = editableFields.contactName;
                        if (editableFields.contactPhone) displayData.contact.phone = editableFields.contactPhone;
                    }
                }
                currentBlob.publicInfo = displayData;
                await displayEmergencyInfo(currentBlob);
                updateSourceLabel();
            } catch (e) {
                console.log('Could not load editable fields', e);
            }
        }

        async function handleOfflineQR(data) {
            currentKey = data.k;
            const publicInfo = {
                name: data.n,
                bloodType: data.b,
                allergies: data.a,
                contact: data.c ? JSON.parse(atob(data.c)) : null
            };
            const privateInfo = data.p
                ? JSON.parse(await decrypt(data.p, data.k))
                : null;
            currentBlob = { publicInfo, privateInfo };
            currentSource = 'Offline QR';
            await displayEmergencyInfo(currentBlob, {
                banner: '‚úÖ Offline QR - No internet required'
            });
            updateSourceLabel();
        }


        async function handleCloudQR(parts) {
            const [guid, key, name, created] = parts.map(p => decodeURIComponent(p || ''));
            if (guid && key) {
                currentMode = 'view';
                showLoadingScreen(name);
                await loadAndDisplayEmergencyInfo(guid, key, name, created);
            } else {
                currentMode = 'create';
                showCreationForm();
            }
        }

        async function fetchFromArchive(guid, key) {
            const cache = await fetchFromCache(guid);
            let chosen = null;
            let source = '';

            if (cache) {
                chosen = cache;
                source = 'Server cache';
                console.log('Loaded from Xano cache');
            } else {
                try {
                    const archiveUrl = `${ARCHIVE_BASE}${guid}.json?ts=${Date.now()}`;
                    const response = await fetch(archiveUrl, { mode: 'cors', cache: 'no-store' });
                    if (response.ok) {
                        chosen = await response.json();
                        source = 'Archive.org';
                    } else {
                        console.log('Archive.org response status:', response.status);
                    }
                } catch (e) {
                    console.log('Archive fetch failed:', e.message);
                }
            }

            if (chosen) {
                const decrypted = await decrypt(chosen.data, key);
                const fullData = JSON.parse(decrypted);
                currentData = chosen;
                currentBlob = { ...fullData };
                currentSource = source;
                return currentBlob;
            }

            throw new Error('Not found');
        }
        
        // Show loading screen
        function showLoadingScreen(name) {
            const container = document.getElementById('main-content');
            container.innerHTML = `
                <div class="loading-screen">
                    <div class="spinner"></div>
                    <p>Loading personal information${name ? ` for ${name}` : ''}...</p>
                </div>
            `;
        }
        
        // Load and display emergency info
        async function loadAndDisplayEmergencyInfo(guid, key, urlName, created) {
            currentGUID = guid;
            currentKey = key;

            console.log('Loading emergency info for:', guid);
            console.log('Created timestamp:', created);

            const createdTime = created ? new Date(decodeURIComponent(created)) : null;
            let banner = null;
            let data;
            let fetchSuccess = false;
            let source = '';

            // Calculate age of QR code
            if (createdTime) {
                const ageMinutes = (Date.now() - createdTime.getTime()) / 60000;
                console.log('QR code age in minutes:', ageMinutes);

                if (ageMinutes < 5) {
                    banner = '‚è≥ Data still uploading to backup servers (usually takes 5-30 minutes). QR code works locally in the meantime.';
                } else if (ageMinutes < 30) {
                    banner = '‚è≥ Data may still be uploading to backup servers. If not loading, please wait a few more minutes.';
                }
            }

            try {
                const cache = await fetchFromCache(guid);
                if (cache) {
                    data = cache;
                    fetchSuccess = true;
                    source = 'Server cache';
                    console.log('Loaded from Xano cache');
                }
            } catch (e) {
                console.log('Cache fetch failed:', e.message);
            }

            if (!fetchSuccess) {
                try {
                    const archiveUrl = `${ARCHIVE_BASE}${guid}.json?ts=${Date.now()}`;
                    console.log('Fetching from Archive.org:', archiveUrl);

                    const response = await fetch(archiveUrl, { mode: 'cors', cache: 'no-store' });
                    console.log('Archive.org response status:', response.status);

                    if (response.ok) {
                        const archiveData = await response.json();
                        const cacheOrder = data ? getRecordOrder(data) : 0;
                        const archiveOrder = getRecordOrder(archiveData);

                        if (!data || archiveOrder > cacheOrder) {
                            data = archiveData;
                            source = 'Archive.org';
                            console.log('Using newer data from Archive.org');
                        } else {
                            console.log('Xano cache is newer than Archive.org');
                        }
                        fetchSuccess = true;
                    } else {
                        throw new Error('Not found on Archive.org');
                    }
                } catch (error) {
                    console.log('Archive fetch failed:', error.message);
                }
            }

            if (!fetchSuccess) {
                // Check local storage fallback
                const localData = localStorage.getItem('pending_' + guid);
                if (localData) {
                    console.log('Found local fallback data');
                    const parsed = JSON.parse(localData);
                    data = { local: true, full: parsed };
                    source = 'Local cache';
                }
            }

            if (!fetchSuccess && createdTime) {
                const ageMinutes = (Date.now() - createdTime.getTime()) / 60000;
                if (ageMinutes < 5) {
                    banner = '‚è≥ Data uploading to Archive.org - this usually takes 5-30 minutes. Your QR works locally for now!';
                } else if (ageMinutes < 30) {
                    banner = '‚è≥ Data may still be uploading - Archive.org backup can take up to 30 minutes to complete';
                } else {
                    banner = '‚ö†Ô∏è Data not found on Archive.org - backup may have failed. Try re-uploading.';
                }
            }

            if (!data) {
                await displayEmergencyInfo({ publicInfo: { name: urlName || 'Unknown' } }, { overrideName: urlName, banner });
                return;
            }

            try {
                let fullData;
                if (data.local) {
                    fullData = data.full;
                } else {
                    const decrypted = await decrypt(data.data, key);
                    fullData = JSON.parse(decrypted);
                }

                // Validate beacon
                if (fullData.beacon !== BEACON_TEXT) {
                    throw new Error('Invalid QR code');
                }

                currentData = data;
                currentBlob = { ...fullData };
                currentSource = source;

                await displayEmergencyInfo(fullData, { overrideName: urlName, banner });
                updateSourceLabel();
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Unable to load personal information. Please check the QR code.');
            }
        }

        // Display emergency information
        async function displayEmergencyInfo(fullData, options = {}) {
            const container = document.getElementById('main-content');

            const publicInfo = fullData.publicInfo || {};
            const nameToShow = options.overrideName || fullData.name || publicInfo.name || 'Unknown';

            let html = `
                <div class="info-card">
                    <div class="info-header">
                        <h2><span class="info-icon">üîë</span><span data-i18n="emergencyInfo">Personal Information</span></h2>
                    </div>
                    ${options.banner ? `<div class="status-message status-info">${options.banner}</div>` : ''}

                    <div class="content">
                        <div class="info-section">
                            <div class="info-item">
                                <span class="info-icon">üë§</span>
                                <div class="info-content">
                                    <div class="info-label" data-i18n="name">Name</div>
                                    <div class="info-value">${nameToShow}</div>
                                </div>
                            </div>
            `;
            if (fullData.pronouns) {
                html += `
                            <div class="info-item">
                                <span class="info-icon">üó£Ô∏è</span>
                                <div class="info-content">
                                    <div class="info-label" data-i18n="pronouns">Pronouns</div>
                                    <div class="info-value">${fullData.pronouns}</div>
                                </div>
                            </div>
                `;
            }

            if (fullData.criticalInfo) {
                html += `
                            <div class="info-item">
                                <span class="info-icon">‚ö†Ô∏è</span>
                                <div class="info-content">
                                    <div class="info-label" data-i18n="criticalInfo">Critical Information</div>
                                    <div class="info-value">${fullData.criticalInfo}</div>
                                </div>
                            </div>
                `;
            }
            
            if (publicInfo.bloodType) {
                html += `
                            <div class="info-item">
                                <span class="info-icon">ü©∏</span>
                                <div class="info-content">
                                    <div class="info-label" data-i18n="bloodType">Blood Type</div>
                                    <div class="info-value">${publicInfo.bloodType}</div>
                                </div>
                            </div>
                `;
            }
            
            if (publicInfo.allergies) {
                html += `
                            <div class="info-item">
                                <span class="info-icon">‚ö†Ô∏è</span>
                                <div class="info-content">
                                    <div class="info-label" data-i18n="allergies">Allergies</div>
                                    <div class="info-value">${publicInfo.allergies}</div>
                                </div>
                            </div>
                `;
            }

            if (publicInfo.medications) {
                html += `
                            <div class="info-item">
                                <span class="info-icon">üíä</span>
                                <div class="info-content">
                                    <div class="info-label" data-i18n="medications">Medications</div>
                                    <div class="info-value">${publicInfo.medications}</div>
                                </div>
                            </div>
                `;
            }
            
            html += `</div>`;
            
            if (publicInfo.contact) {
                html += `
                        <div class="info-section">
                            <div class="info-item">
                                <span class="info-icon">üìû</span>
                                <div class="info-content">
                                    <div class="info-label" data-i18n="emergencyContact">Primary Contact</div>
                                    <div class="info-value">
                                        ${publicInfo.contact.name}${publicInfo.contact.relationship ? ' (' + publicInfo.contact.relationship + ')' : ''}
                                        <a href="tel:${publicInfo.contact.phone}" class="phone-link">
                                            üì± ${publicInfo.contact.phone}
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                `;
            }
            if (publicInfo.secondaryContact) {
                html += `
                        <div class="info-section">
                            <div class="info-item">
                                <span class="info-icon">üìû</span>
                                <div class="info-content">
                                    <div class="info-label">Secondary Contact</div>
                                    <div class="info-value">
                                        ${publicInfo.secondaryContact.name}${publicInfo.secondaryContact.relationship ? ' (' + publicInfo.secondaryContact.relationship + ')' : ''}
                                        <a href="tel:${publicInfo.secondaryContact.phone}" class="phone-link">
                                            üì± ${publicInfo.secondaryContact.phone}
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                `;
            }

            html += `
                        <div class="emergency-card">
                            <h3>üö® Emergency Services</h3>
                            <p style="margin-bottom:8px;">Tap to open</p>
                            <button class="access-911" onclick="confirmEmergencyAccess()" title="Tap to activate">
                                Access Emergency Services
                            </button>
                        </div>
                `;

            html += `
                        <div class="help-link">
                            <a href="#" onclick="toggleHelp(); return false;">How It Works</a>
                            <div id="help-content" class="help-content"></div>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = html;
            setLanguage(currentLanguage);
        }

        async function ownerLogin() {
            if (!currentGUID) {
                alert('No QR code loaded. Please create or load one before logging in.');
                return;
            }
            let password = ownerPassword;
            if (!password) {
                password = prompt('Please enter your password to archive new data for this iKey.');
                if (!password) {
                    return;
                }
            }
            const verified = await verifyOwnerPassword(password);
            if (verified) {
                ownerPassword = password;
                sessionStorage.setItem('ownerPassword', ownerPassword);
                document.querySelector('.login-btn').style.display = 'none';
                document.querySelector('.dashboard-btn').style.display = 'inline-block';
                document.querySelector('.logout-btn').style.display = 'inline-block';
                document.querySelector('.notes-tab-btn').style.display = 'inline-block';
                showOwnerDashboard();
                startSessionTimer();
                document.querySelector('.health-records-btn').style.display = 'inline-block';
            }
        }

        async function logoutOwner() {
            ownerPassword = null;
            sessionStorage.removeItem('ownerPassword');
            sessionStorage.removeItem('ownerSessionExpires');

            document.querySelector('.dashboard-btn').style.display = 'none';
            document.querySelector('.health-records-btn').style.display = 'none';
            document.querySelector('.logout-btn').style.display = 'none';
            document.querySelector('.notes-tab-btn').style.display = 'none';
            document.querySelector('.login-btn').style.display = 'inline-block';

            localStorage.removeItem('ikey_last_view');

            if (sessionTimeoutHandle) {
                clearTimeout(sessionTimeoutHandle);
                sessionTimeoutHandle = null;
            }

            if (currentGUID && currentKey) {
                await displayEmergencyInfo(currentBlob);
            } else {
                showCreationForm();
            }

            document.getElementById('healthRecordsTab').style.display = 'none';
            document.getElementById('text911Tab').style.display = 'none';
            document.getElementById('resourcesTab').style.display = 'none';
            document.getElementById('qrTab').style.display = 'block';
        }

        function startSessionTimer(remaining) {
            if (sessionTimeoutHandle) {
                clearTimeout(sessionTimeoutHandle);
            }
            const duration = remaining !== undefined ? remaining : SESSION_DURATION;
            sessionStorage.setItem('ownerSessionExpires', Date.now() + duration);
            sessionTimeoutHandle = setTimeout(() => {
                alert('Session timed out');
                logoutOwner().catch(console.error);
            }, duration);
        }

        async function verifyOwnerPassword(password) {
            // Check stored hash to confirm password before allowing owner access
            if (!currentBlob?.privateInfo?.encryptedWith) {
                return true; // nothing to verify
            }
            try {
                const hash = await sha256Hash(currentKey + password);
                if (hash === currentBlob.privateInfo.encryptedWith) {
                    return true;
                }
            } catch (e) {
                console.error('Password verification failed', e);
            }
            alert('Incorrect password');
            return false;
        }

        function showOwnerDashboard() {
            if (!currentBlob) {
                console.error('Cannot show dashboard - no data loaded');
                alert('No data loaded for this iKey.');
                return;
            }
            // Ensure the dashboard content is visible regardless of the current tab
            document.getElementById('qrTab').style.display = 'block';
            document.getElementById('text911Tab').style.display = 'none';
            document.getElementById('healthRecordsTab').style.display = 'none';
            document.getElementById('resourcesTab').style.display = 'none';

            currentMode = 'dashboard';
            const container = document.getElementById('main-content');

            const fields = {
                basic: {
                    name: currentBlob.name,
                    pronouns: currentBlob.pronouns,
                    criticalInfo: currentBlob.criticalInfo
                },
                emergency: {
                    bloodType: currentBlob.publicInfo?.bloodType,
                    allergies: currentBlob.publicInfo?.allergies,
                    medications: currentBlob.publicInfo?.medications
                },
                contacts: {
                    primary: currentBlob.publicInfo?.contact,
                    secondary: currentBlob.publicInfo?.secondaryContact
                },
                private: {
                    ssn: currentBlob.privateInfo?.ssn,
                    insurance: currentBlob.privateInfo?.insurance,
                    medicalNotes: currentBlob.privateInfo?.notes
                },
                vault: {
                    records: currentBlob.vault?.records?.length || 0
                }
            };

            let totalFields = 0;
            let filledFields = 0;

            const checkField = (value) => {
                totalFields++;
                if (value && value !== '' && value !== '-') {
                    filledFields++;
                    return true;
                }
                return false;
            };

            const sections = {
                basic: { filled: 0, total: 2 },
                emergency: { filled: 0, total: 3 },
                contacts: { filled: 0, total: 2 },
                private: { filled: 0, total: 3 },
                vault: { filled: 0, total: 1 }
            };

            if (checkField(fields.basic.name)) sections.basic.filled++;
            if (checkField(fields.basic.criticalInfo)) sections.basic.filled++;
            if (checkField(fields.emergency.bloodType)) sections.emergency.filled++;
            if (checkField(fields.emergency.allergies)) sections.emergency.filled++;
            if (checkField(fields.emergency.medications)) sections.emergency.filled++;
            if (checkField(fields.contacts.primary?.name)) sections.contacts.filled++;
            if (checkField(fields.contacts.secondary?.name)) sections.contacts.filled++;
            if (checkField(fields.private.ssn)) sections.private.filled++;
            if (checkField(fields.private.insurance)) sections.private.filled++;
            if (checkField(fields.private.medicalNotes)) sections.private.filled++;
            if (fields.vault.records > 0) sections.vault.filled++;

            const completionPercent = Math.round((filledFields / totalFields) * 100);

            container.innerHTML = `
                <div class="dashboard-container">
                    <div class="dashboard-header">
                        <div class="progress-ring">
                            <svg width="120" height="120">
                                <circle cx="60" cy="60" r="54" fill="none" stroke="#e0e0e0" stroke-width="8"/>
                                <circle cx="60" cy="60" r="54" fill="none" stroke="#667eea" stroke-width="8"
                                        stroke-dasharray="${339 * completionPercent / 100} 339"
                                        transform="rotate(-90 60 60)"/>
                            </svg>
                            <div class="progress-text">
                                <div class="percent">${completionPercent}%</div>
                                <div class="label">Complete</div>
                            </div>
                        </div>
                        <div class="profile-summary">
                            <h2>${fields.basic.name || 'Your iKey'}</h2>
                            <p class="profile-status">Profile ${completionPercent}% complete</p>
                            <p class="last-updated">Last updated: <span id="last-updated-time">${currentBlob.metadata?.updated || 'Never'}</span> <span id="autosave-status"></span><br><small id="data-source"></small></p>
                        </div>
                    </div>

                    <div class="section-cards">
                        ${renderSectionCard('Basic Info', 'üë§', sections.basic, [
                            { label: 'Name', value: fields.basic.name, required: true },
                            ...(fields.basic.pronouns ? [{ label: 'Pronouns', value: fields.basic.pronouns }] : []),
                            { label: 'Critical Info', value: fields.basic.criticalInfo }
                        ], null, 'basic')}

                        ${renderSectionCard('Emergency', 'üö®', sections.emergency, [
                            { label: 'Blood Type', value: fields.emergency.bloodType },
                            { label: 'Allergies', value: fields.emergency.allergies },
                            { label: 'Medications', value: fields.emergency.medications, missing: true, section: 'emergency', field: 'medications' }
                        ], null, 'emergency')}

                        ${renderSectionCard('Contacts', 'üìû', sections.contacts, [
                            { label: 'Primary', value: fields.contacts.primary?.name },
                            { label: 'Secondary', value: fields.contacts.secondary?.name, missing: true, section: 'contacts', field: 'secondary' }
                        ], null, 'contacts')}

                        ${renderSectionCard('Private', 'üîí', sections.private, [
                            { label: 'SSN', value: fields.private.ssn, masked: true },
                            { label: 'Insurance', value: fields.private.insurance, missing: true, section: 'private', field: 'insurance' },
                            { label: 'Notes', value: fields.private.medicalNotes }
                        ], null, 'private')}

                        ${renderSectionCard('Electronic Health Records', 'üè•', sections.vault, [
                            { label: 'Records', value: fields.vault.records + ' documents' }
                        ], 'showHealthRecordsTabSafe()', 'vault')}
                        <div class="emergency-card">
                            <h3>üö® Emergency Services</h3>
                            <p style="margin-bottom:8px;">Tap to open</p>
                            <button class="access-911" onclick="confirmEmergencyAccess()" title="Tap to activate">
                                Access Emergency Services
                            </button>
                        </div>
                    </div>

                    <div class="quick-actions">
                        <button onclick="viewQR()" class="action-btn">View QR</button>
                        <button onclick="downloadQRFixed()" class="action-btn">Download QR</button>
                        <button onclick="shareQR()" class="action-btn">Share</button>
                    </div>
                </div>
            `;

            const updatedEl = document.getElementById('last-updated-time');
            if (updatedEl) {
                updatedEl.textContent = currentBlob.metadata?.updated ? new Date(currentBlob.metadata.updated).toLocaleString() : 'Never';
            }
            updateSourceLabel();

            localStorage.setItem('ikey_last_view', 'dashboard');
            localStorage.setItem('ikey_current_guid', currentGUID);

            startSessionTimer();
        }

        function renderSectionCard(title, icon, progress, fields, onClick, sectionKey) {
            const percent = Math.round((progress.filled / progress.total) * 100);
            const clickAttr = onClick ? ` onclick="${onClick}" style="cursor:pointer"` : '';
            const actionButton = sectionKey === 'vault'
                ? `<button class="edit-section-btn" onclick="event.stopPropagation(); showHealthRecordsTabSafe()">Open</button>`
                : `<button class="edit-section-btn" onclick="event.stopPropagation(); openEditModal('${sectionKey}')">Edit</button>`;
            return `
                <div class="section-card ${percent === 100 ? 'complete' : ''}"${clickAttr}>
                    <div class="section-header">
                        <span class="section-icon">${icon}</span>
                        <h3>${title}</h3>
                        <div class="mini-progress">
                            <div class="home-progress__bar" style="width: ${percent}%"></div>
                        </div>
                    </div>
                    <div class="section-fields">
                        ${fields.map(f => `
                            <div class="field-row ${f.missing ? 'missing' : ''}">
                                <span class="field-label">${f.label}</span>
                                <span class="field-value">
                                    ${f.missing ? `<span class="add-button" onclick="addFieldModal('${f.section}','${f.field}')">+ Add</span>` :
                                     (f.masked ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : (f.value || '‚Äî'))}
                                </span>
                            </div>
                        `).join('')}
                    </div>
                    ${actionButton}
                </div>
            `;
        }

        function openEditModal(section) {
            const titles = {
                basic: 'Basic Info',
                emergency: 'Emergency',
                contacts: 'Contacts',
                private: 'Private',
                vault: 'Electronic Health Records'
            };
            const modal = document.createElement('div');
            modal.className = 'field-modal active';
            modal.innerHTML = `
                <div class="modal-backdrop" onclick="closeModal()"></div>
                <div class="modal-content">
                    <h3>Edit ${titles[section] || ''}</h3>
                    ${getSectionInputs(section)}
                    <div class="modal-actions">
                        <button onclick="saveSection('${section}')" class="btn-primary">Save</button>
                        <button onclick="closeModal()" class="btn-ghost">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            const firstInput = modal.querySelector('input, textarea, select');
            if (firstInput) firstInput.focus();
        }

        function getSectionInputs(section) {
            switch (section) {
                case 'basic':
                    return `
                        <input id="edit-name" type="text" placeholder="Name" value="${currentBlob?.name || ''}">
                        <input id="edit-pronouns" type="text" placeholder="Pronouns" value="${currentBlob?.pronouns || ''}">
                        <textarea id="edit-critical" placeholder="Critical Info">${currentBlob?.criticalInfo || ''}</textarea>`;
                case 'emergency':
                    const bt = currentBlob?.publicInfo?.bloodType || '';
                    return `
                        <select id="edit-blood">
                            <option value="">Blood Type</option>
                            ${['A+','A-','B+','B-','AB+','AB-','O+','O-'].map(o => `<option value="${o}" ${bt===o?'selected':''}>${o}</option>`).join('')}
                        </select>
                        <textarea id="edit-allergies" placeholder="Allergies">${currentBlob?.publicInfo?.allergies || ''}</textarea>
                        <textarea id="edit-medications" placeholder="Medications">${currentBlob?.publicInfo?.medications || ''}</textarea>`;
                case 'contacts':
                    return `
                        <input id="edit-primary-name" type="text" placeholder="Primary Name" value="${currentBlob?.publicInfo?.contact?.name || ''}">
                        <input id="edit-primary-phone" type="tel" placeholder="Primary Phone" value="${currentBlob?.publicInfo?.contact?.phone || ''}">
                        <input id="edit-secondary-name" type="text" placeholder="Secondary Name" value="${currentBlob?.publicInfo?.secondaryContact?.name || ''}">
                        <input id="edit-secondary-phone" type="tel" placeholder="Secondary Phone" value="${currentBlob?.publicInfo?.secondaryContact?.phone || ''}">`;
                case 'private':
                    return `
                        <input id="edit-ssn" type="text" placeholder="SSN" value="${currentBlob?.privateInfo?.ssn || ''}">
                        <input id="edit-insurance-provider" type="text" placeholder="Insurance Provider" value="${currentBlob?.privateInfo?.insurance?.provider || ''}">
                        <input id="edit-insurance-policy" type="text" placeholder="Policy #" value="${currentBlob?.privateInfo?.insurance?.policy || ''}">
                        <textarea id="edit-notes" placeholder="Notes">${currentBlob?.privateInfo?.notes || ''}</textarea>`;
                default:
                    return `<p>No editable fields.</p>`;
            }
        }

        function saveSection(section) {
            if (!currentBlob) currentBlob = {};
            switch (section) {
                case 'basic':
                    currentBlob.name = document.getElementById('edit-name').value.trim();
                    currentBlob.pronouns = document.getElementById('edit-pronouns').value.trim();
                    currentBlob.criticalInfo = document.getElementById('edit-critical').value.trim();
                    break;
                case 'emergency':
                    currentBlob.publicInfo = currentBlob.publicInfo || {};
                    currentBlob.publicInfo.bloodType = document.getElementById('edit-blood').value;
                    currentBlob.publicInfo.allergies = document.getElementById('edit-allergies').value.trim();
                    currentBlob.publicInfo.medications = document.getElementById('edit-medications').value.trim();
                    break;
                case 'contacts':
                    currentBlob.publicInfo = currentBlob.publicInfo || {};
                    currentBlob.publicInfo.contact = {
                        name: document.getElementById('edit-primary-name').value.trim(),
                        phone: document.getElementById('edit-primary-phone').value.trim()
                    };
                    currentBlob.publicInfo.secondaryContact = {
                        name: document.getElementById('edit-secondary-name').value.trim(),
                        phone: document.getElementById('edit-secondary-phone').value.trim()
                    };
                    break;
                case 'private':
                    currentBlob.privateInfo = currentBlob.privateInfo || {};
                    currentBlob.privateInfo.ssn = document.getElementById('edit-ssn').value.trim();
                    const provider = document.getElementById('edit-insurance-provider').value.trim();
                    const policy = document.getElementById('edit-insurance-policy').value.trim();
                    currentBlob.privateInfo.insurance = provider || policy ? { provider, policy } : undefined;
                    currentBlob.privateInfo.notes = document.getElementById('edit-notes').value.trim();
                    break;
                default:
                    break;
            }
            closeModal();
            showOwnerDashboard();
        }

        function addFieldModal(section, field) {
            const modal = document.createElement('div');
            modal.className = 'field-modal active';
            modal.innerHTML = `
                <div class="modal-backdrop" onclick="closeModal()"></div>
                <div class="modal-content">
                    <h3>Add ${field}</h3>
                    ${getFieldInput(section, field)}
                    <div class="modal-actions">
                        <button onclick="saveField('${section}', '${field}')" class="btn-primary">Save</button>
                        <button onclick="closeModal()" class="btn-ghost">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            const firstInput = modal.querySelector('input, textarea, select');
            if (firstInput) firstInput.focus();
        }

        function getFieldInput(section, field) {
            const configs = {
                'emergency.medications': '<textarea class="field-input" placeholder="List current medications, dosages, and frequency"></textarea>',
                'emergency.bloodType': '<select class="field-input"><option>A+</option><option>A-</option><option>B+</option><option>B-</option><option>AB+</option><option>AB-</option><option>O+</option><option>O-</option></select>',
                'contacts.secondary': '<input class="field-input" type="text" placeholder="Name"><input class="field-input2" type="tel" placeholder="Phone">',
                'private.insurance': '<input class="field-input" type="text" placeholder="Provider"><input class="field-input2" type="text" placeholder="Policy #">'
            };
            return configs[`${section}.${field}`] || '<input class="field-input" type="text">';
        }

        function closeModal() {
            const modal = document.querySelector('.field-modal');
            if (modal) modal.remove();
        }

        function saveField(section, field) {
            const input = document.querySelector('.field-modal .field-input');
            const input2 = document.querySelector('.field-modal .field-input2');
            const value = input ? input.value.trim() : '';
            const value2 = input2 ? input2.value.trim() : '';

            if (!currentBlob) currentBlob = {};
            if (section === 'emergency') {
                currentBlob.publicInfo = currentBlob.publicInfo || {};
                currentBlob.publicInfo[field] = value;
            } else if (section === 'contacts' && field === 'secondary') {
                currentBlob.publicInfo = currentBlob.publicInfo || {};
                currentBlob.publicInfo.secondaryContact = { name: value, phone: value2 };
            } else if (section === 'private') {
                currentBlob.privateInfo = currentBlob.privateInfo || {};
                currentBlob.privateInfo[field] = value2 ? { provider: value, policy: value2 } : value;
            }
            closeModal();
            showOwnerDashboard();
        }

        async function showUpdateForm(password) {
            try {
                const verified = await verifyOwnerPassword(password);
                if (!verified) return false;

                showCreationForm();

                const form = document.getElementById('create-form');

                const publicInfo = currentBlob.publicInfo || {};

                document.getElementById('name').value = currentBlob.name || '';
                document.getElementById('pronouns').value = currentBlob.pronouns || '';
                document.getElementById('critical-info').value = currentBlob.criticalInfo || '';
                if (publicInfo.bloodType) {
                    const bt = document.querySelector(`input[name="blood-type"][value="${publicInfo.bloodType}"]`);
                    if (bt) bt.checked = true;
                }
                document.getElementById('allergies').value = publicInfo.allergies || '';
                document.getElementById('medications').value = publicInfo.medications || '';
                document.getElementById('contact-name').value = publicInfo.contact?.name || '';
                document.getElementById('contact-phone').value = publicInfo.contact?.phone || '';
                document.getElementById('contact-relationship').value = publicInfo.contact?.relationship || '';
                if (publicInfo.secondaryContact) {
                    document.getElementById('add-secondary-contact').click();
                    document.getElementById('secondary-contact-name').value = publicInfo.secondaryContact.name || '';
                    document.getElementById('secondary-contact-phone').value = publicInfo.secondaryContact.phone || '';
                    document.getElementById('secondary-contact-relationship').value = publicInfo.secondaryContact.relationship || '';
                }

                document.getElementById('password').parentElement.style.display = 'none';
                document.getElementById('password').required = false;
                document.getElementById('password-confirm').parentElement.style.display = 'none';
                document.getElementById('password-confirm').required = false;
                document.getElementById('password-req').style.display = 'none';

                const preview = document.createElement('div');
                preview.id = 'update-preview';
                preview.className = 'info-section';
                form.appendChild(preview);
                function updatePreview() {
                    preview.innerHTML = `
                        <div class="info-item"><div class="info-label">Blood Type</div><div class="info-value">${document.querySelector('input[name="blood-type"]:checked')?.value || ''}</div></div>
                        <div class="info-item"><div class="info-label">Allergies</div><div class="info-value">${document.getElementById('allergies').value}</div></div>
                        <div class="info-item"><div class="info-label">Medications</div><div class="info-value">${document.getElementById('medications').value}</div></div>
                        <div class="info-item"><div class="info-label">Contacts</div><div class="info-value">${document.getElementById('contact-name').value} ${document.getElementById('contact-phone').value}${document.getElementById('secondary-contact-name').value ? '<br>' + document.getElementById('secondary-contact-name').value + ' ' + document.getElementById('secondary-contact-phone').value : ''}</div></div>
                    `;
                }
                ['allergies','medications','contact-name','contact-phone','secondary-contact-name','secondary-contact-phone'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.addEventListener('input', updatePreview);
                });
                document.querySelectorAll('input[name="blood-type"]').forEach(r => r.addEventListener('change', updatePreview));
                updatePreview();

                if (currentBlob.privateInfo) {
                    const privateInfo = currentBlob.privateInfo;
                    document.getElementById('ssn').value = privateInfo.ssn || '';
                    document.getElementById('medical-notes').value = privateInfo.notes || '';
                }

                document.getElementById('create-form').removeEventListener('submit', handleCreateForm);
                document.getElementById('create-form').addEventListener('submit', (e) => handleUpdateForm(e, password));

                document.querySelector('#create-form button[type="submit"]').innerHTML = '<span>Save Emergency Info</span>';
                startSessionTimer();
                return true;

            } catch (error) {
                console.error('Archive error:', error);
                alert('Failed to prepare archive: ' + error.message);
                if (currentBlob) {
                    await displayFullInfo(currentBlob);
                }
                return false;
            }
        }

        async function handleUpdateForm(e, password) {
            e.preventDefault();

            const button = e.target.querySelector('button[type="submit"]');
            button.disabled = true;
            button.innerHTML = '<span>Saving...</span>';

            try {
                // Collect updated form data
                const name = document.getElementById('name').value;
                const pronouns = document.getElementById('pronouns').value;
                const criticalInfo = document.getElementById('critical-info').value;
                const bloodType = document.querySelector('input[name="blood-type"]:checked')?.value || '';
                const contactRelationship = document.getElementById('contact-relationship').value;
                const secondaryName = document.getElementById('secondary-contact-name').value;
                const secondaryPhone = document.getElementById('secondary-contact-phone').value;
                const secondaryRel = document.getElementById('secondary-contact-relationship').value;
                const publicInfo = {
                    bloodType,
                    allergies: document.getElementById('allergies').value,
                    medications: document.getElementById('medications').value,
                    contact: {
                        name: document.getElementById('contact-name').value,
                        phone: document.getElementById('contact-phone').value,
                        relationship: contactRelationship
                    }
                };
                if (secondaryName || secondaryPhone) {
                    publicInfo.secondaryContact = {
                        name: secondaryName,
                        phone: secondaryPhone,
                        relationship: secondaryRel
                    };
                }

                const privateInfo = password ? {
                    ssn: document.getElementById('ssn').value,
                    notes: document.getElementById('medical-notes').value,
                    encryptedWith: await sha256Hash(currentKey + password)
                } : null;

                const payload = { name, pronouns, criticalInfo, publicInfo, privateInfo };
                const encryptedBlob = await encrypt(JSON.stringify(payload), currentKey);

                const archivePayload = {
                    encrypted: true,
                    version: "3.0",
                    data: encryptedBlob
                };
                  let hash = null;
                  if (password) {
                      hash = await computeDoubleHash(password, encryptedBlob);
                  }

                  const response = await fetch(WEBHOOK_URL, {
                      method: 'PUT',
                      headers: {
                          'Content-Type': 'application/json'
                      },
                      body: JSON.stringify({
                          guid: currentGUID,
                          data: archivePayload,
                          doublehash: hash,
                          referer: document.referrer
                      })
                  });

                  if (response.status === 403) {
                      throw new Error('Invalid password - server denied');
                  }
                  if (!response.ok) {
                      throw new Error('Server error');
                  }

                currentData = archivePayload;
                currentBlob = { ...currentBlob, name, pronouns, criticalInfo, publicInfo, privateInfo, metadata: { ...(currentBlob.metadata || {}), updated: new Date().toISOString() } };
                currentSource = 'Server cache';
                showStatus('‚úÖ Data archived!', 'success');
                showOwnerDashboard();

            } catch (error) {
                showStatus('Error: ' + error.message, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = '<span>Save Emergency Info</span>';
            }
        }
        
        // Show creation form
        function showCreationForm() {
            currentMode = 'create';
            const container = document.getElementById('main-content');

            container.innerHTML = `
                <div class="header">
                    <h1 data-i18n="createYourKey">Create Your iKey</h1>
                    <p data-i18n="tagline">Your data. Your key. Your control.</p>
                </div>

                <div class="content">
                      <form id="create-form">
                          <div class="section-title"><span data-i18n="emergencyInfo">Personal Information</span> <span class="section-status incomplete" id="personal-status">Incomplete</span></div>

                          <div class="form-group">
                              <label for="name"><span data-i18n="name">Name</span> *</label>
                              <input type="text" id="name" required placeholder="John Doe" data-i18n-placeholder="contactNamePlaceholder">
                          </div>

                          <div class="form-group">
                              <label for="pronouns"><span data-i18n="pronouns">Pronouns</span></label>
                              <input type="text" id="pronouns" placeholder="e.g., she/her">
                          </div>

                          <div class="form-group">
                              <label for="critical-info"><span data-i18n="criticalInfo">Critical Information</span> (<span data-i18n="optional">Optional</span>)</label>
                              <textarea
                                  id="critical-info"
                                  maxlength="100"
                                  rows="2"
                                  data-i18n-placeholder="criticalInfoPlaceholder"
                                  placeholder="e.g., Severe penicillin allergy, Type 1 diabetic"
                              ></textarea>
                              <div class="field-info">
                                  <span class="char-counter">0/100</span>
                              </div>
                          </div>

                          <div class="form-group">
                              <label data-i18n="bloodType">Blood Type (Optional)</label>
                              <div class="blood-type-grid" id="blood-type">
                                  <label class="blood-type-btn"><input type="radio" name="blood-type" value="A+"><span>A+</span></label>
                                  <label class="blood-type-btn"><input type="radio" name="blood-type" value="B+"><span>B+</span></label>
                                  <label class="blood-type-btn"><input type="radio" name="blood-type" value="AB+"><span>AB+</span></label>
                                  <label class="blood-type-btn"><input type="radio" name="blood-type" value="O+"><span>O+</span></label>
                                  <label class="blood-type-btn"><input type="radio" name="blood-type" value="A-"><span>A-</span></label>
                                  <label class="blood-type-btn"><input type="radio" name="blood-type" value="B-"><span>B-</span></label>
                                  <label class="blood-type-btn"><input type="radio" name="blood-type" value="AB-"><span>AB-</span></label>
                                  <label class="blood-type-btn"><input type="radio" name="blood-type" value="O-"><span>O-</span></label>
                              </div>
                              <button type="button" class="unknown-option" id="blood-type-unknown">I don't know my blood type</button>
                          </div>

                          <div class="form-group">
                              <label for="allergies" data-i18n="allergies">Allergies</label>
                              <textarea id="allergies" placeholder="Penicillin, peanuts, etc." data-i18n-placeholder="allergiesPlaceholder"></textarea>
                          </div>

                          <div class="form-group">
                              <label><span data-i18n="medications">Medications</span></label>
                              <div class="medication-search" style="position:relative;">
                                  <input type="text" id="medication-search" placeholder="Start typing medication name...">
                                  <div id="medication-results" class="search-dropdown"></div>
                              </div>
                              <div id="selected-medications" class="medication-list"></div>
                              <textarea id="medications" placeholder="Current medications" style="display:none;"></textarea>
                              <div id="allergy-warnings" class="allergy-warnings"></div>
                          </div>

                          <div class="form-group">
                              <label for="contact-name"><span data-i18n="emergencyContactName">Primary Contact Name</span> *</label>
                              <input type="text" id="contact-name" required placeholder="e.g., Jane Doe" data-i18n-placeholder="contactNamePlaceholder">
                          </div>

                          <div class="form-group">
                              <label for="contact-phone"><span data-i18n="emergencyContactPhone">Primary Contact Phone</span> *</label>
                              <input type="tel" id="contact-phone" required placeholder="(555) 123-4567" data-i18n-placeholder="contactPhonePlaceholder">
                          </div>

                          <div class="form-group">
                              <label for="contact-relationship">Relationship</label>
                              <select id="contact-relationship">
                                  <option value="">Select relationship</option>
                                  <option>Spouse</option>
                                  <option>Parent</option>
                                  <option>Sibling</option>
                                  <option>Child</option>
                                  <option>Friend</option>
                                  <option>Other</option>
                              </select>
                          </div>

                          <button type="button" id="add-secondary-contact" class="btn-secondary">+ Add Secondary Contact</button>

                          <div id="secondary-contact" style="display:none;">
                              <div class="form-group">
                                  <label for="secondary-contact-name">Secondary Contact Name</label>
                                  <input type="text" id="secondary-contact-name" placeholder="e.g., John Doe">
                              </div>
                              <div class="form-group">
                                  <label for="secondary-contact-phone">Secondary Contact Phone</label>
                                  <input type="tel" id="secondary-contact-phone" placeholder="(555) 987-6543">
                              </div>
                              <div class="form-group">
                                  <label for="secondary-contact-relationship">Relationship</label>
                                  <select id="secondary-contact-relationship">
                                      <option value="">Select relationship</option>
                                      <option>Spouse</option>
                                      <option>Parent</option>
                                      <option>Sibling</option>
                                      <option>Child</option>
                                      <option>Friend</option>
                                      <option>Other</option>
                                  </select>
                              </div>
                          </div>

                          <div class="section-title"><span data-i18n="passwordProtected">Password Protected</span> <span class="section-status incomplete" id="password-status">Incomplete</span></div>

                          <div class="form-group">
                              <label for="ssn"><span data-i18n="ssn">Social Security Number</span></label>
                              <input type="text" id="ssn" placeholder="XXX-XX-XXXX" data-i18n-placeholder="ssnPlaceholder">
                          </div>

                          <div class="form-group">
                              <label for="medical-notes"><span data-i18n="medicalNotes">Medical Notes</span></label>
                              <textarea id="medical-notes" placeholder="Medications, conditions, etc." data-i18n-placeholder="medicalNotesPlaceholder"></textarea>
                          </div>

                        <div class="form-group">
                            <label for="password"><span data-i18n="password">Password</span> *</label>
                            <input type="password" id="password" required placeholder="Choose a password" data-i18n-placeholder="choosePassword">
                            <div id="password-strength" class="hint"></div>
                        </div>

                        <div class="form-group">
                            <label for="password-confirm"><span data-i18n="confirmPassword">Confirm Password</span> *</label>
                            <input type="password" id="password-confirm" required placeholder="Re-enter password" data-i18n-placeholder="reenterPassword">
                        </div>

                        <div class="hint" id="password-req" data-i18n="passwordRequirements">
                            A strong password is required to create your code. It must be at least 8 characters and include upper and lower case letters, a number, and a special character. Without it you cannot save changes or modify protected content.
                        </div>

                        <div class="hint" data-i18n="passwordWarning">
                            Store this password somewhere safe. If you lose it, you'll need to create a new code and any password-protected data will be lost forever.
                        </div>

                        <button type="submit" class="btn">
                            <span data-i18n="createKey">Create iKey</span>
                        </button>
                    </form>

                    <div id="qr-result" style="display: none;">
                        <div class="qr-display">
                            <h3>‚úÖ Your iKey Created</h3>
                            <p style="color: #666; font-size: 0.875rem; margin: 10px 0;">
                                ‚úì Encrypted with zero-knowledge security<br>
                                ‚úì Backed up to Archive.org<br>
                                ‚úì Only this QR can decrypt your data
                            </p>
                            <div id="qrcode"></div>
                            <div class="action-buttons">
                                <button class="btn" onclick="downloadQRFixed()">üíæ <span data-i18n="download">Download</span></button>
                                <button class="btn" onclick="testQR()">üîç <span data-i18n="test">Test</span></button>
                            </div>
                            <div class="status-message status-info" style="margin-top: 15px;">
                                <strong>Important:</strong> Save this QR code! It contains the only key to your data.
                            </div>
                        </div>
                    </div>

                    <div id="status-message"></div>

                    <div class="help-link">
                        <a href="#" onclick="toggleHelp(); return false;">How It Works</a>
                        <div id="help-content-secondary" class="help-content"></div>
                    </div>
                </div>
            `;

            setLanguage(currentLanguage);

            // Add form submit handler
            document.getElementById('create-form').addEventListener('submit', handleCreateForm);

            initMedicationField();
            initContactSection();
            initBloodTypeSelector();
            initSectionStatus();

            // Password strength meter
            document.getElementById('password').addEventListener('input', () => {
                const pwd = document.getElementById('password').value;
                const strengthEl = document.getElementById('password-strength');
                strengthEl.textContent = `Strength: ${getPasswordStrength(pwd)}`;
            });

            // Critical info character counter
            const ci = document.getElementById('critical-info');
            const counter = ci.parentElement.querySelector('.char-counter');
            ci.addEventListener('input', () => {
                counter.textContent = `${ci.value.length}/100`;
            });
        }

        // Handle form submission
        async function handleCreateForm(e) {
            e.preventDefault();

            const button = e.target.querySelector('button[type="submit"]');
            button.disabled = true;
            button.innerHTML = '<span>Creating & Securing...</span>';

            try {
                const password = document.getElementById('password').value;
                const confirmPassword = document.getElementById('password-confirm').value;

                if (!password) {
                    throw new Error('Password is required');
                }
                if (!isStrongPassword(password)) {
                    throw new Error('Password does not meet requirements');
                }
                if (password !== confirmPassword) {
                    throw new Error('Passwords do not match');
                }

                alert('Store this password somewhere safe. Without it, you cannot archive new data or modify the protected content.');

                if (!(await ensureHealthApp())) {
                    throw new Error('Health records module not loaded');
                }

                // Generate identifiers and keys
                currentGUID = generateGUID();
                currentKey = generateKey();
                const created = new Date().toISOString();

                // Collect form data
                const formData = {
                    name: document.getElementById('name').value,
                    pronouns: document.getElementById('pronouns').value,
                    criticalInfo: document.getElementById('critical-info').value,
                    bloodType: document.querySelector('input[name="blood-type"]:checked')?.value || '',
                    allergies: document.getElementById('allergies').value,
                    medications: document.getElementById('medications').value,
                    contactName: document.getElementById('contact-name').value,
                    contactPhone: document.getElementById('contact-phone').value,
                    contactRelationship: document.getElementById('contact-relationship').value,
                    secondaryName: document.getElementById('secondary-contact-name').value,
                    secondaryPhone: document.getElementById('secondary-contact-phone').value,
                    secondaryRelationship: document.getElementById('secondary-contact-relationship').value,
                    ssn: document.getElementById('ssn').value,
                    notes: document.getElementById('medical-notes').value,
                    passwordHint: document.getElementById('password-hint')?.value || ''
                };

                // Prepare encrypted data
                const publicInfo = {
                    bloodType: formData.bloodType,
                    allergies: formData.allergies,
                    medications: formData.medications,
                    contact: { name: formData.contactName, phone: formData.contactPhone, relationship: formData.contactRelationship }
                };
                if (formData.secondaryName || formData.secondaryPhone) {
                    publicInfo.secondaryContact = {
                        name: formData.secondaryName,
                        phone: formData.secondaryPhone,
                        relationship: formData.secondaryRelationship
                    };
                }

                const privateInfo = password ? {
                    ssn: formData.ssn,
                    notes: formData.notes,
                    encryptedWith: await sha256Hash(currentKey + password)
                } : null;

                const payload = {
                    name: formData.name,
                    pronouns: formData.pronouns,
                    criticalInfo: formData.criticalInfo,
                    publicInfo,
                    privateInfo,
                    passwordHint: formData.passwordHint,
                    vault: window.healthApp.exportVault()
                };
                const encryptedData = await encrypt(JSON.stringify(payload), currentKey);

                const archivePayload = {
                    encrypted: true,
                    version: "3.0",
                    data: encryptedData
                };
                let hash = null;
                if (password) {
                    hash = await computeDoubleHash(password, encryptedData);
                }

                currentData = archivePayload;

                // IMMEDIATELY upload to server
                showStatus('‚è≥ Securing your data online...', 'info');

                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        guid: currentGUID,
                        data: archivePayload,
                        doublehash: hash,
                        referer: document.referrer
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to secure data online');
                }

                currentSource = 'Server cache';
                updateSourceLabel();

                // Only generate QR after successful upload
                const qrUrl = `${VIEWER_URL}#${currentGUID}|${currentKey}|${encodeURIComponent(formData.name)}|${created}`;
                window.location.hash = `${currentGUID}|${currentKey}|${encodeURIComponent(formData.name)}|${created}`;

                // Generate QR code
                const qrContainer = document.getElementById('qrcode');
                qrContainer.innerHTML = '';
                new QRCode(qrContainer, {
                    text: qrUrl,
                    width: 256,
                    height: 256,
                    correctLevel: QRCode.CorrectLevel.M
                });

                window.currentQRUrl = qrUrl;

                currentBlob = {
                    version: 'v2',
                    created,
                    name: formData.name,
                    pronouns: formData.pronouns,
                    criticalInfo: formData.criticalInfo,
                    publicInfo,
                    privateInfo,
                    vault: window.healthApp.exportVault()
                };

                // Show success
                document.getElementById('create-form').style.display = 'none';
                document.getElementById('qr-result').style.display = 'block';
                showStatus('iKey created and secured online!', 'success');

            } catch (error) {
                showStatus('Error: ' + error.message, 'error');
                // Don't create QR if upload failed
            } finally {
                button.disabled = false;
                button.innerHTML = '<span data-i18n="createKey">Create iKey</span>';
                setLanguage(currentLanguage);
            }
        }


        // Utility functions
        function generateGUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        function generateKey(length = 32) {
            const array = new Uint8Array(length);
            crypto.getRandomValues(array);
            return btoa(String.fromCharCode.apply(null, array))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        function getPasswordStrength(pwd) {
            let score = 0;
            if (pwd.length >= 8) score++;
            if (/[a-z]/.test(pwd)) score++;
            if (/[A-Z]/.test(pwd)) score++;
            if (/\d/.test(pwd)) score++;
            if (/[^A-Za-z0-9]/.test(pwd)) score++;
            if (pwd.length >= 12) score++;
            if (score >= 5) return 'Strong';
            if (score >= 3) return 'Medium';
            return 'Weak';
        }

        function isStrongPassword(pwd) {
            return /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^A-Za-z0-9]).{8,}$/.test(pwd);
        }

        function initContactSection() {
            const btn = document.getElementById('add-secondary-contact');
            const section = document.getElementById('secondary-contact');
            if (btn && section) {
                btn.addEventListener('click', () => {
                    section.style.display = section.style.display === 'none' ? 'block' : 'none';
                });
            }
            const primaryName = document.getElementById('contact-name');
            const primaryPhone = document.getElementById('contact-phone');
            if (primaryName) {
                primaryName.value = '';
                primaryName.placeholder = 'e.g., Jane Doe';
            }
            if (primaryPhone) {
                primaryPhone.value = '';
                primaryPhone.placeholder = '(555) 123-4567';
            }
        }

        function initBloodTypeSelector() {
            const buttons = document.querySelectorAll('.blood-type-btn');
            const unknown = document.getElementById('blood-type-unknown');
            if (!buttons.length || !unknown) return;

            buttons.forEach(btn => {
                const input = btn.querySelector('input');
                btn.addEventListener('click', () => {
                    buttons.forEach(b => b.classList.remove('selected'));
                    unknown.classList.remove('selected');
                    if (input) input.checked = true;
                    btn.classList.add('selected');
                });
            });

            unknown.addEventListener('click', () => {
                buttons.forEach(b => {
                    const inp = b.querySelector('input');
                    if (inp) inp.checked = false;
                    b.classList.remove('selected');
                });
                unknown.classList.add('selected');
            });
        }

        function initSectionStatus() {
            const personalStatus = document.getElementById('personal-status');
            const passwordStatus = document.getElementById('password-status');

            function updatePersonal() {
                const name = document.getElementById('name')?.value.trim();
                const cName = document.getElementById('contact-name')?.value.trim();
                const cPhone = document.getElementById('contact-phone')?.value.trim();
                if (name && cName && cPhone) {
                    personalStatus.textContent = 'Complete';
                    personalStatus.classList.add('complete');
                    personalStatus.classList.remove('incomplete');
                } else {
                    personalStatus.textContent = 'Incomplete';
                    personalStatus.classList.add('incomplete');
                    personalStatus.classList.remove('complete');
                }
            }

            function updatePassword() {
                const pwd = document.getElementById('password')?.value;
                const pwd2 = document.getElementById('password-confirm')?.value;
                if (pwd && pwd === pwd2 && isStrongPassword(pwd)) {
                    passwordStatus.textContent = 'Complete';
                    passwordStatus.classList.add('complete');
                    passwordStatus.classList.remove('incomplete');
                } else {
                    passwordStatus.textContent = 'Incomplete';
                    passwordStatus.classList.add('incomplete');
                    passwordStatus.classList.remove('complete');
                }
            }

            ['name', 'contact-name', 'contact-phone'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', updatePersonal);
            });
            ['password', 'password-confirm'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', updatePassword);
            });

            updatePersonal();
            updatePassword();
        }

        async function encrypt(text, password) {
            const enc = new TextEncoder();
            const salt = crypto.getRandomValues(new Uint8Array(16));
            const iv = crypto.getRandomValues(new Uint8Array(12));
            
            const passwordKey = await crypto.subtle.importKey(
                "raw",
                enc.encode(password),
                "PBKDF2",
                false,
                ["deriveBits", "deriveKey"]
            );
            
            const aesKey = await crypto.subtle.deriveKey(
                {
                    name: "PBKDF2",
                    salt: salt,
                    iterations: 100000,
                    hash: "SHA-256"
                },
                passwordKey,
                { 
                    name: "AES-GCM",
                    length: 256
                },
                false,
                ["encrypt"]
            );
            
            const encrypted = await crypto.subtle.encrypt(
                { 
                    name: "AES-GCM",
                    iv: iv,
                    tagLength: 128
                },
                aesKey,
                enc.encode(text)
            );
            
            const encryptedContent = new Uint8Array(encrypted);
            const buf = new Uint8Array(salt.byteLength + iv.byteLength + encryptedContent.byteLength);
            buf.set(salt, 0);
            buf.set(iv, salt.byteLength);
            buf.set(encryptedContent, salt.byteLength + iv.byteLength);
            
            return btoa(String.fromCharCode(...buf));
        }
        
        async function decrypt(encryptedData, password) {
            const enc = new TextEncoder();
            const dec = new TextDecoder();
            
            const data = Uint8Array.from(atob(encryptedData), c => c.charCodeAt(0));
            const salt = data.slice(0, 16);
            const iv = data.slice(16, 28);
            const encrypted = data.slice(28);
            
            const passwordKey = await crypto.subtle.importKey(
                "raw",
                enc.encode(password),
                "PBKDF2",
                false,
                ["deriveBits", "deriveKey"]
            );
            
            const aesKey = await crypto.subtle.deriveKey(
                {
                    name: "PBKDF2",
                    salt: salt,
                    iterations: 100000,
                    hash: "SHA-256"
                },
                passwordKey,
                { 
                    name: "AES-GCM",
                    length: 256
                },
                false,
                ["decrypt"]
            );
            
            const decrypted = await crypto.subtle.decrypt(
                { 
                    name: "AES-GCM",
                    iv: iv,
                    tagLength: 128
                },
                aesKey,
                encrypted
            );
            
            return dec.decode(decrypted);
        }

        async function generateUpdateToken(password, guid) {
            // Deterministic token from password + guid
            const encoder = new TextEncoder();
            const data = encoder.encode(password + guid + "UPDATE_SALT_V1");
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode(...new Uint8Array(hashBuffer)))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        async function sha256Hash(text) {
            const encoder = new TextEncoder();
            const data = encoder.encode(text);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function computeDoubleHash(password, encrypted) {
            const first = await sha256Hash(password + encrypted);
            return await sha256Hash(first);
        }

        async function fetchFromCache(guid) {
            try {
                const resp = await fetch(
                    `${XANO_BASE}/ikey_cache?guid=${encodeURIComponent(guid)}`,
                    { method: 'GET', mode: 'cors', cache: 'no-store' }
                );
                if (!resp.ok) return null;
                const record = await resp.json();
                return record || null;
            } catch (e) {
                return null;
            }
        }

        function updateSourceLabel() {
            const el = document.getElementById('data-source');
            if (el) {
                el.textContent = currentSource ? `Source: ${currentSource}` : '';
            }
        }




        async function createDemoData(guid, key) {
            const fullData = {
                version: "2.0",
                created: new Date().toISOString(),
                beacon: BEACON_TEXT,
                publicInfo: {
                    name: "Demo User",
                    bloodType: "O+",
                    allergies: "Penicillin, Peanuts",
                    contact: {
                        name: "Primary Contact",
                        phone: "(555) 123-4567"
                    }
                },
                privateInfo: {
                    ssn: "XXX-XX-XXXX",
                    notes: "This is demo data. Password is: demo",
                    encryptedWith: await sha256Hash(key + "demo")
                }
            };

            const encryptedBlob = await encrypt(JSON.stringify(fullData), key);
            return {
                encrypted: true,
                version: "3.0",
                data: encryptedBlob
            };
        }

        function viewQR() {
            const created = currentBlob?.created || new Date().toISOString();
            const name = currentBlob?.name || '';
            const url = window.currentQRUrl || `${VIEWER_URL}#${currentGUID}|${currentKey}|${encodeURIComponent(name)}|${created}`;
            const existing = document.getElementById('qr-viewer');
            if (existing) existing.remove();
            const overlay = document.createElement('div');
            overlay.id = 'qr-viewer';
            overlay.className = 'qr-overlay';
            overlay.innerHTML = `<div class="qr-modal"><div id="owner-qr"></div><button class="btn" onclick="document.getElementById('qr-viewer').remove()">Close</button></div>`;
            overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });
            document.body.appendChild(overlay);
            new QRCode(document.getElementById('owner-qr'), {
                text: url,
                width: 256,
                height: 256
            });
        }

        function downloadQRFixed() {
            const canvas = document.querySelector('#qrcode canvas, #owner-qr canvas');
            const created = currentBlob?.created || new Date().toISOString();
            const name = currentBlob?.name || '';
            const url = window.currentQRUrl || `${VIEWER_URL}#${currentGUID}|${currentKey}|${encodeURIComponent(name)}|${created}`;
            if (!canvas) {
                const tempDiv = document.createElement('div');
                new QRCode(tempDiv, {
                    text: url,
                    width: 256,
                    height: 256
                });
                setTimeout(() => {
                    const newCanvas = tempDiv.querySelector('canvas');
                    if (newCanvas) {
                        const link = document.createElement('a');
                        link.download = `ikey-${currentBlob.name || 'emergency'}.png`;
                        link.href = newCanvas.toDataURL();
                        link.click();
                    }
                }, 100);
            } else {
                const link = document.createElement('a');
                link.download = `ikey-${currentBlob.name || 'emergency'}.png`;
                link.href = canvas.toDataURL();
                link.click();
            }
        }

        function shareQR() {
            const created = currentBlob?.created || new Date().toISOString();
            const name = currentBlob?.name || '';
            const url = window.currentQRUrl || `${VIEWER_URL}#${currentGUID}|${currentKey}|${encodeURIComponent(name)}|${created}`;
            if (navigator.share && url) {
                navigator.share({ title: 'iKey', url }).catch(() => {});
            } else if (url) {
                prompt('QR URL', url);
            }
        }

        function testQR() {
            if (window.currentQRUrl) {
                window.open(window.currentQRUrl, '_blank');
            }
        }
        
        function showStatus(message, type) {
            const element = document.getElementById('status-message');
            if (!element) return;
            
            element.className = 'status-message status-' + type;
            element.textContent = message;
            element.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    element.style.display = 'none';
                }, 5000);
            }
        }
        
        function showError(message) {
            const container = document.getElementById('main-content');
            container.innerHTML = `
                <div class="header">
                    <h1>‚ùå Error</h1>
                </div>
                <div class="content">
                    <div class="status-message status-error">
                        ${message}
                    </div>
                    <button class="btn" onclick="showCreationForm()">Create New iKey</button>
                </div>
            `;
        }
        
        function toggleHelp() {
            const helpContent = document.getElementById('help-content');
            if (!helpContent) return;
            
            if (helpContent.classList.contains('active')) {
                helpContent.classList.remove('active');
            } else {
                helpContent.innerHTML = `
                    <h4>How iKey Works</h4>
                    <p>Your information is encrypted before leaving your device:</p>
                    <ul>
                        <li>‚úì Public info helps in emergencies</li>
                        <li>‚úì Private info needs your password</li>
                        <li>üîë Your iKey code is the only way to decrypt</li>
                    </ul>
                    <p><strong>True Security:</strong><br>
                    Not even iKey can access your data. The QR code contains<br>
                    the only decryption key that exists. Lose it = lose access forever.</p>
                `;
                helpContent.classList.add('active');
            }
        }
        
        // Dev Tools Functions
        function toggleDevTools() {
            const panel = document.getElementById('dev-panel');
            panel.classList.toggle('active');
        }
        
        async function devLoadQR() {
            const guid = document.getElementById('dev-guid').value;
            const key = document.getElementById('dev-key').value;
            
            if (!guid || !key) {
                document.getElementById('dev-output').textContent = 'Please enter both GUID and Key';
                return;
            }
            
            document.getElementById('dev-output').textContent = 'Loading...';
            
            try {
                await loadAndDisplayEmergencyInfo(guid, key, null, null);
                document.getElementById('dev-output').textContent = 'Successfully loaded QR data';
            } catch (error) {
                document.getElementById('dev-output').textContent = 'Error: ' + error.message;
            }
        }
        
        async function devTestArchive() {
            const guid = document.getElementById('dev-guid').value;
            if (!guid) {
                document.getElementById('dev-output').textContent = 'Please enter a GUID';
                return;
            }
            
            document.getElementById('dev-output').textContent = `Testing GUID: ${guid}\n\nFetching...`;

            let cache = null;
            try {
                cache = await fetchFromCache(guid);
            } catch (e) {
                console.log('Cache fetch failed:', e.message);
            }

            if (cache) {
                document.getElementById('dev-output').textContent =
                    `Loaded from Xano backup\n\nRaw JSON:\n${JSON.stringify(cache, null, 2)}`;
                return;
            }

            try {
                const archiveUrl = `${ARCHIVE_BASE}${guid}.json?ts=${Date.now()}`;
                const response = await fetch(archiveUrl, { mode: 'cors', cache: 'no-store' });
                if (response.ok) {
                    const archiveData = await response.json();
                    document.getElementById('dev-output').textContent =
                        `Loaded from Archive.org\n\nRaw JSON:\n${JSON.stringify(archiveData, null, 2)}`;
                    return;
                }
                console.log('Archive.org response status:', response.status);
            } catch (error) {
                console.log('Archive fetch failed:', error.message);
            }

            document.getElementById('dev-output').textContent =
                `Not found on Archive.org or Xano backup.`;
        }
        
        async function devScanQR() {
            const file = document.getElementById('dev-qr-upload').files[0];
            const output = document.getElementById('dev-output');
            if (!file) {
                output.textContent = 'Please select a QR image file';
                return;
            }

            output.textContent = 'Scanning QR image...';
            try {
                const data = await scanFileForQR(file);
                if (!data) {
                    output.textContent = 'Unable to read QR code from image';
                    return;
                }

                output.textContent = `QR detected: ${data}`;
                const { guid, key } = parseQRData(data);
                await loadAndDisplayEmergencyInfo(guid, key, null, null);
                output.textContent += '\nLoaded QR data';
            } catch (error) {
                output.textContent = 'Error: ' + error.message;
            }
        }

        function parseQRData(text) {
            let guid, key;
            if (text.includes('#') && text.includes('|')) {
                const hash = text.split('#')[1];
                [guid, key] = hash.split('|');
            } else if (text.includes('v2:')) {
                const hash = text.split('#')[1];
                const parts = hash.split(':');
                guid = parts[1];
                key = parts[2];
            } else if (text.includes('http')) {
                const parts = text.split('#');
                const url = new URL(parts[0]);
                guid = url.searchParams.get('guid');
                key = parts[1];
            } else if (text.includes('#')) {
                [guid, key] = text.split('#');
            }
            if (!guid || !key) {
                throw new Error('Invalid QR data');
            }
            return { guid, key };
        }

        function scanFileForQR(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const code = jsQR(imageData.data, canvas.width, canvas.height);
                        resolve(code ? code.data : null);
                    };
                    img.onerror = () => reject(new Error('Invalid image')); 
                    img.src = reader.result;
                };
                reader.onerror = () => reject(new Error('File reading failed'));
                reader.readAsDataURL(file);
            });
        }
        
        function devShowRawData() {
            if (!currentData) {
                document.getElementById('dev-output').textContent = 'No data loaded';
                return;
            }
            
            document.getElementById('dev-output').textContent = 
                `Current Data:\n\n` +
                `GUID: ${currentGUID}\n` +
                `Key: ${currentKey}\n` +
                `Mode: ${currentMode}\n\n` +
                `Raw Data:\n${JSON.stringify(currentData, null, 2)}`;
        }
        
         function devClearStorage() {
             currentGUID = null;
             currentKey = null;
             currentData = null;
             document.getElementById('dev-output').textContent = 'All data cleared';
         }

         let location911Enabled = false;

        window.addEventListener('message', function(e) {
            if (e.data && e.data.type === 'text911Height') {
                const frame = document.getElementById('text911Frame');
                if (frame) {
                    frame.style.height = e.data.height + 'px';
                }
            } else if (e.data && e.data.type === 'closeHealthRecords') {
                showQRTab();
            }
        });

         function show911Tab() {
            document.getElementById('qrTab').style.display = 'none';
            document.getElementById('healthRecordsTab').style.display = 'none';
            document.getElementById('resourcesTab').style.display = 'none';
            document.getElementById('text911Tab').style.display = 'block';

             if (!location911Enabled) {
                 document.getElementById('location-permission-prompt').style.display = 'block';
                 document.getElementById('location-content').style.display = 'none';
             }
         }

        function confirmEmergencyAccess() {
            if (confirm('Open Emergency Services?')) {
                show911Tab();
            }
        }

       async function showHealthRecordsTab() {
            if (!(await ensureHealthApp())) {
                alert('Health records module not loaded.');
                return;
            }
            if (!ownerPassword) {
                await ownerLogin();
                if (!ownerPassword) return;
            }
            try {
                await window.healthApp.loadVault(ownerPassword);
                document.getElementById('qrTab').style.display = 'none';
                document.getElementById('text911Tab').style.display = 'none';
                document.getElementById('resourcesTab').style.display = 'none';
                const frame = document.getElementById('healthRecordsFrame');
                const setFrameHeight = () => {
                    const scale = window.getCurrentScale ? window.getCurrentScale() : 1;
                    const topBar = document.querySelector('.top-bar');
                    const offset = topBar ? topBar.offsetHeight : 0;
                    frame.style.height = ((window.innerHeight - offset) / scale) + 'px';
                };
                setFrameHeight();
                window.addEventListener('resize', setFrameHeight);
                if (!frame.src) {
                    frame.src = 'health-records.html';
                }
                document.getElementById('healthRecordsTab').style.display = 'block';
            } catch (e) {
                alert('Unable to unlock health records');
            }
        }

        function showResourcesTab() {
            document.getElementById('qrTab').style.display = 'none';
            document.getElementById('healthRecordsTab').style.display = 'none';
            document.getElementById('text911Tab').style.display = 'none';
            const frame = document.getElementById('resourcesFrame');
            const setFrameHeight = () => {
                const scale = window.getCurrentScale ? window.getCurrentScale() : 1;
                const topBar = document.querySelector('.top-bar');
                const offset = topBar ? topBar.offsetHeight : 0;
                frame.style.height = ((window.innerHeight - offset) / scale) + 'px';
            };
            setFrameHeight();
            window.addEventListener('resize', setFrameHeight);
            if (!frame.src) {
                frame.src = 'https://wttin.org/';
            }
            document.getElementById('resourcesTab').style.display = 'block';
        }

         function showQRTab() {
             document.getElementById('qrTab').style.display = 'block';
             document.getElementById('text911Tab').style.display = 'none';
             document.getElementById('healthRecordsTab').style.display = 'none';
             document.getElementById('resourcesTab').style.display = 'none';
         }

        function showPrivacy() {
            const existing = document.getElementById('privacy-viewer');
            if (existing) existing.remove();
            const guid = currentGUID || localStorage.getItem('ikey_current_guid') || '';
            const overlay = document.createElement('div');
            overlay.id = 'privacy-viewer';
            overlay.className = 'qr-overlay';
            const src = 'privacy.html' + (guid ? `?guid=${encodeURIComponent(guid)}` : '');
            overlay.innerHTML = `<div class="qr-modal" style="width:90%;height:90%;max-width:1000px;display:flex;flex-direction:column;"><iframe src="${src}" style="flex:1;border:none;border-radius:10px;"></iframe><button class="btn" onclick="document.getElementById('privacy-viewer').remove()">Close</button></div>`;
            overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });
            document.body.appendChild(overlay);
        }

        async function requestLocationAndLoad911() {
            try {
                document.getElementById('location-permission-prompt').style.display = 'none';
                document.getElementById('location-loading').style.display = 'block';
                await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            location911Enabled = true;
                            document.getElementById('location-loading').style.display = 'none';
                            document.getElementById('location-content').style.display = 'block';
                            const iframe = document.getElementById('text911Frame');
                            iframe.src = 'text911.html';
                            resolve();
                        },
                        (error) => {
                            document.getElementById('location-loading').style.display = 'none';
                            document.getElementById('location-permission-prompt').style.display = 'block';
                            alert('Location access is required for 911 emergency features. Please enable location in your browser settings.');
                            reject(error);
                        },
                        { enableHighAccuracy: true }
                    );
                });
            } catch (error) {
                document.getElementById('location-loading').style.display = 'none';
                document.getElementById('location-permission-prompt').style.display = 'block';
                alert('Unable to access location. Please check your browser settings.');
            }
        }

         // Add click handler for logo to return to QR
         document.addEventListener('DOMContentLoaded', function() {
             document.querySelector('.logo').addEventListener('click', showQRTab);
         });

         // Allow closing dev tools
         document.addEventListener('keydown', function(e) {
             if (e.key === 'Escape') {
                 document.getElementById('dev-panel').classList.remove('active');
            }
        });

        document.addEventListener('click', function(e) {
            const panel = document.getElementById('dev-panel');
            if (panel.classList.contains('active') &&
                !e.target.closest('.dev-panel') &&
                !e.target.closest('.dev-trigger')) {
                panel.classList.remove('active');
            }
        });

        // Triple-click to show dev tools
        let clickCount = 0;
        let clickTimer = null;
        
        document.addEventListener('click', function(e) {
            if (e.target.closest('.dev-trigger') || e.target.closest('.dev-panel')) return;
            
            clickCount++;
            
            if (clickCount === 3) {
                document.querySelector('.dev-trigger').style.opacity = '1';
                clickCount = 0;
            }
            
            clearTimeout(clickTimer);
            clickTimer = setTimeout(() => {
                clickCount = 0;
            }, 500);
        });

</script>
  </body>
</html>