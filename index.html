<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>iKey</title>
<style>
  body { font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,sans-serif; margin:0; }
  .hidden { display:none; }
  .top-bar { position:fixed; top:0; left:0; right:0; background:#fff; box-shadow:0 2px 6px rgba(0,0,0,0.1); padding:10px 20px; display:flex; justify-content:space-between; align-items:center; z-index:1000; }
  .main { padding-top:60px; max-width:900px; margin:0 auto; }
  .options-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:20px; }
  .option-card { border:2px solid #e5e7eb; border-radius:12px; padding:30px; cursor:pointer; text-align:center; transition:transform .2s,border-color .2s; background:#fff; }
  .option-card:hover { transform:translateY(-4px); border-color:#667eea; }
  #qrcode { margin-top:20px; }
  #bulk-output { display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:20px; margin-top:20px; }
  .bulk-item { text-align:center; }
  #video { margin-top:20px; }
  #diagnostics { background:#f8f8f8; padding:8px; text-align:center; font-size:14px; }
  @media print {
    .top-bar, #home, #create-controls, #scan-controls { display:none; }
    #bulk { display:block; }
    body { margin:0; }
  }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
</head>
<body>
<div id="diagnostics"></div>
<div class="top-bar">
  <div>iKey</div>
  <div>
    <button onclick="setTextSize(1)">A</button>
    <button onclick="setTextSize(1.25)">A+</button>
    <select id="lang-select" onchange="setLanguage(this.value)">
      <option value="en">EN</option>
      <option value="es">ES</option>
    </select>
  </div>
</div>
<div class="main">
  <section id="home">
    <div class="options-grid">
      <div class="option-card" onclick="showCreateScreen()" id="card-create">Create QR</div>
      <div class="option-card" onclick="showBulkScreen()" id="card-bulk">Bulk QRs</div>
      <div class="option-card" onclick="showScanScreen()" id="card-scan">Scan QR</div>
    </div>
  </section>
  <section id="create" class="hidden">
    <h2 id="create-title">Create QR</h2>
    <textarea id="qr-input" rows="4" style="width:100%;"></textarea>
    <div id="create-controls">
      Size: <input type="number" id="qr-size" value="256" style="width:70px;">
      Margin: <input type="number" id="qr-margin" value="4" style="width:50px;">
      <button onclick="generateQR()" id="btn-generate">Generate</button>
      <button onclick="downloadQR()" id="btn-download">Download PNG</button>
      <button onclick="showHome()" id="btn-back-create">Back</button>
    </div>
    <div id="qrcode"></div>
  </section>
  <section id="bulk" class="hidden">
    <h2 id="bulk-title">Bulk QR</h2>
    <textarea id="bulk-input" rows="6" style="width:100%;" placeholder="One item per line"></textarea>
    <div id="bulk-controls">
      <button onclick="generateBulk()" id="btn-generate-bulk">Generate Sheet</button>
      <button onclick="window.print()" id="btn-print">Print</button>
      <button onclick="showHome()" id="btn-back-bulk">Back</button>
    </div>
    <div id="bulk-output"></div>
  </section>
  <section id="scan" class="hidden">
    <h2 id="scan-title">Scan QR</h2>
    <div id="scan-controls">
      <button onclick="startCamera()" id="btn-start">Start Camera</button>
      <button onclick="stopCamera()" id="btn-stop">Stop</button>
      <input type="file" accept="image/*" onchange="scanImage(this.files[0])">
      <button onclick="showHome()" id="btn-back-scan">Back</button>
    </div>
    <video id="video" width="300" height="200" style="border:1px solid #ccc"></video>
    <canvas id="scan-canvas" class="hidden"></canvas>
    <p id="scan-result"></p>
  </section>
</div>
<script>
function showDiagnostics(){
  const status = `QRCode: ${window.QRCode?"✅":"❌"} | jsQR: ${window.jsQR?"✅":"❌"}`;
  document.getElementById('diagnostics').textContent = status;
}
showDiagnostics();

function setTextSize(scale){
  document.documentElement.style.fontSize = (16*scale)+"px";
}
const translations={
  en:{create:"Create QR",bulk:"Bulk QRs",scan:"Scan QR"},
  es:{create:"Crear QR",bulk:"QRs en lote",scan:"Escanear QR"}
};
function setLanguage(lang){
  const t=translations[lang];
  document.getElementById('card-create').textContent=t.create;
  document.getElementById('card-bulk').textContent=t.bulk;
  document.getElementById('card-scan').textContent=t.scan;
  document.getElementById('create-title').textContent=t.create;
  document.getElementById('bulk-title').textContent=t.bulk;
  document.getElementById('scan-title').textContent=t.scan;
}

function showSection(id){
  ['home','create','bulk','scan'].forEach(sec=>document.getElementById(sec).classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}
function showHome(){showSection('home');}
function showCreateScreen(){showSection('create');}
function showBulkScreen(){showSection('bulk');}
function showScanScreen(){showSection('scan');}

let qr;
function generateQR(){
  const text=document.getElementById('qr-input').value;
  const size=parseInt(document.getElementById('qr-size').value,10);
  const margin=parseInt(document.getElementById('qr-margin').value,10);
  const container=document.getElementById('qrcode');
  container.innerHTML='';
  if(!text)return;
  qr=new QRCode(container,{text,width:size,height:size,margin:margin});
}
function downloadQR(){
  const canvas=document.querySelector('#qrcode canvas');
  if(!canvas)return;
  const url=canvas.toDataURL('image/png');
  const a=document.createElement('a');
  a.href=url; a.download='qr.png'; a.click();
}

function generateBulk(){
  const lines=document.getElementById('bulk-input').value.split(/\n+/).filter(Boolean);
  const out=document.getElementById('bulk-output');
  out.innerHTML='';
  lines.forEach(text=>{
    const item=document.createElement('div');
    item.className='bulk-item';
    const div=document.createElement('div');
    item.appendChild(div);
    new QRCode(div,{text,width:128,height:128,margin:2});
    const cap=document.createElement('div');
    cap.textContent=text;
    item.appendChild(cap);
    out.appendChild(item);
  });
}

let videoStream;
function startCamera(){
  navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}}).then(stream=>{
    videoStream=stream;
    const video=document.getElementById('video');
    video.srcObject=stream; video.play();
    requestAnimationFrame(scanFrame);
  });
}
function stopCamera(){
  if(videoStream){
    videoStream.getTracks().forEach(t=>t.stop());
    videoStream=null;
  }
}
function scanFrame(){
  if(!videoStream) return;
  const video=document.getElementById('video');
  const canvas=document.getElementById('scan-canvas');
  const ctx=canvas.getContext('2d');
  canvas.width=video.videoWidth; canvas.height=video.videoHeight;
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  const imageData=ctx.getImageData(0,0,canvas.width,canvas.height);
  const code=jsQR(imageData.data,canvas.width,canvas.height);
  if(code){
    document.getElementById('scan-result').textContent=code.data;
    stopCamera();
  } else {
    requestAnimationFrame(scanFrame);
  }
}
function scanImage(file){
  const reader=new FileReader();
  reader.onload=e=>{
    const img=new Image();
    img.onload=()=>{
      const canvas=document.getElementById('scan-canvas');
      const ctx=canvas.getContext('2d');
      canvas.width=img.width; canvas.height=img.height;
      ctx.drawImage(img,0,0);
      const data=ctx.getImageData(0,0,canvas.width,canvas.height);
      const code=jsQR(data.data,canvas.width,canvas.height);
      document.getElementById('scan-result').textContent=code?code.data:'No QR code found';
    };
    img.src=e.target.result;
  };
  if(file) reader.readAsDataURL(file);
}
</script>
</body>
</html>
