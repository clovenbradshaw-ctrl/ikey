<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Emergency QR</title>
    
    <style>
        /* Softr embedding fixes */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            margin: 0 !important;
            padding: 0 !important;
            overflow-x: hidden !important;
            width: 100% !important;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        .container {
            width: calc(100vw - 40px) !important;
            max-width: 500px !important;
            margin: 20px auto !important;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            animation: slideIn 0.3s ease;
        }

        @media (max-width: 600px) {
            .container {
                width: 100% !important;
                border-radius: 0 !important;
                margin: 0 !important;
            }

            body {
                background: white !important;
                align-items: flex-start !important;
            }
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .content {
            padding: 20px;
        }
        
        /* Emergency Display Mode */
        .emergency-card {
            animation: fadeIn 0.5s ease;
        }
        
        .emergency-header {
            background: #ff4757;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .emergency-header h2 {
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .info-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .info-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .info-item:last-child {
            margin-bottom: 0;
        }
        
        .info-icon {
            font-size: 20px;
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        .info-content {
            flex: 1;
        }
        
        .info-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 2px;
        }
        
        .info-value {
            font-size: 16px;
            color: #2c3e50;
            font-weight: 500;
        }
        
        .phone-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
            padding: 8px 12px;
            background: #e8f0fe;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .phone-link:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }
        
        .private-section {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .private-section h3 {
            color: #856404;
            font-size: 16px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .password-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ffc107;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .hint {
            font-size: 12px;
            color: #856404;
            margin-bottom: 10px;
            font-style: italic;
        }
        
        /* Creation Form Mode */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #2c3e50;
            font-weight: 500;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        .section-title {
            font-size: 16px;
            color: #2c3e50;
            margin: 25px 0 15px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
            font-weight: 600;
        }
        
        .section-title:first-of-type {
            margin-top: 0;
            padding-top: 0;
            border-top: none;
        }
        
        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: #6c757d;
            margin-top: 10px;
        }
        
        .btn-outline {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            margin-top: 10px;
        }
        
        .btn-outline:hover {
            background: #667eea;
            color: white;
        }
        
        /* QR Display */
        .qr-display {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        #qrcode {
            display: inline-block;
            padding: 15px;
            background: white;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* Help Section */
        .help-link {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }
        
        .help-link a {
            color: #667eea;
            text-decoration: none;
            font-size: 14px;
        }
        
        .help-content {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
            font-size: 14px;
            line-height: 1.6;
            display: none;
        }
        
        .help-content.active {
            display: block;
        }
        
        /* Loading State */
        .loading-screen {
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(102, 126, 234, 0.3);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .upload-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeIn 0.5s ease;
        }

        .security-container {
            max-width: 500px;
            text-align: center;
            color: white;
            padding: 40px;
        }

        .archive-logo {
            width: 60px;
            height: 60px;
            margin-bottom: 30px;
            opacity: 0;
            transition: opacity 1s ease;
        }

        .security-progress {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin-bottom: 40px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 2px;
        }

        .security-step {
            transition: opacity 0.3s ease;
        }

        .step-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        #step-title {
            font-size: 24px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        #step-message {
            font-size: 16px;
            opacity: 0.9;
            line-height: 1.5;
        }

        .step-indicators {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 40px;
        }

        .indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .indicator.active {
            background: white;
            transform: scale(1.5);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Dev Tools */
        .dev-trigger {
            position: fixed;
            bottom: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .dev-trigger:hover {
            opacity: 1;
        }
        
        .dev-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #2c3e50;
            color: white;
            padding: 20px;
            transform: translateY(100%);
            transition: transform 0.3s;
            max-height: 50vh;
            overflow-y: auto;
        }
        
        .dev-panel.active {
            transform: translateY(0);
        }
        
        .dev-panel h3 {
            margin-bottom: 15px;
            color: white;
        }
        
        .dev-panel input,
        .dev-panel textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .dev-panel button {
            padding: 8px 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .dev-output {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
        }
        
        /* Mobile Responsive */
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .container {
                border-radius: 15px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .action-buttons {
                grid-template-columns: 1fr;
            }
        }
        
        /* Status Messages */
        .status-message {
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
            font-size: 14px;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-info {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffc107;
            font-weight: 600;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }

        .upload-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            overflow: hidden;
        }

        .upload-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .upload-content {
            padding: 30px;
            min-height: 300px;
        }

        .data-preview, .key-generation, .encryption-visual,
        .security-layers, .archive-upload, .success-summary {
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .data-item {
            padding: 8px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .data-item.locked {
            background: #fff3cd;
            border: 1px solid #ffc107;
        }

        .key-display {
            background: #2c3e50;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            margin: 15px 0;
        }

        .huge-number {
            font-size: 12px;
            color: #666;
            word-break: break-all;
        }

        .comparison {
            color: #667eea;
            font-weight: 600;
            margin-top: 10px;
        }

        .data-transform {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }

        .before, .after {
            margin: 10px 0;
        }

        .arrow {
            text-align: center;
            color: #667eea;
            font-weight: bold;
            margin: 15px 0;
        }

        .layer {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px;
            background: #f0f8ff;
            border-radius: 8px;
            margin: 10px 0;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }

        .summary-item {
            display: flex;
            gap: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 12px;
        }

        .final-reminder {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
        }

        .feature-note {
            color: #856404;
            font-style: italic;
        }

        .progress-bar {
            height: 6px;
            background: #e9ecef;
            margin: 0 30px 20px;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            width: 0;
            background: #667eea;
            transition: width 0.5s ease;
        }

        .language-selector {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            padding: 8px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .primary-languages {
            display: flex;
            gap: 6px;
        }

        .lang-btn {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 60px;
            font-size: 14px;
        }

        .lang-btn:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }

        .lang-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .lang-native {
            font-weight: 500;
            white-space: nowrap;
        }


        .more-languages-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: transform 0.3s;
        }

        .more-languages-btn:hover {
            transform: scale(1.1);
        }

        .globe-icon {
            font-size: 20px;
        }

        .plus-icon {
            position: absolute;
            top: 5px;
            right: 5px;
            background: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 12px;
            color: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .secondary-languages {
            position: absolute;
            top: 60px;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            padding: 12px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            min-width: 200px;
        }

        body.rtl {
            direction: rtl;
            text-align: right;
        }

        body.rtl .language-selector {
            left: 10px;
            right: auto;
        }

body.rtl .info-icon {
            margin-left: 12px;
            margin-right: 0;
        }

        @media (max-width: 480px) {
            .primary-languages {
                flex-wrap: wrap;
            }

            .lang-btn .lang-native {
                font-size: 12px;
            }

  .secondary-languages {
    grid-template-columns: 1fr;
    width: calc(100vw - 20px);
    }
  }
        /* Critical info helper */
        .field-info {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #555;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="language-selector">
        <div class="primary-languages"></div>

        <button class="more-languages-btn" onclick="toggleMoreLanguages()">
            <span class="globe-icon">🌍</span>
            <span class="plus-icon">+</span>
        </button>

        <div class="secondary-languages" style="display: none;"></div>
    </div>
    <div class="container">
        <div id="main-content">
            <!-- Content will be dynamically inserted here -->
        </div>
    </div>
    
    <!-- Dev Tools Panel -->
    <div class="dev-trigger" onclick="toggleDevTools()">🛠️</div>
    <div id="dev-panel" class="dev-panel">
        <h3>🛠️ Dev Tools</h3>
        
        <div style="margin-bottom: 15px;">
            <input type="text" id="dev-guid" placeholder="Enter GUID">
            <input type="text" id="dev-key" placeholder="Enter Key">
            <button onclick="devLoadQR()">Load QR</button>
            <button onclick="devTestArchive()">Test Archive Fetch</button>
        </div>
        
        <div style="margin-bottom: 15px;">
            <input type="file" id="dev-qr-upload" accept="image/*" style="margin-bottom: 10px;">
            <button onclick="devScanQR()">Scan QR Image</button>
        </div>
        
        <div style="margin-bottom: 15px;">
            <button onclick="devShowRawData()">Show Raw Data</button>
            <button onclick="devClearStorage()">Clear All Data</button>
            <button onclick="toggleDevTools()">Close</button>
        </div>
        
        <div class="dev-output" id="dev-output"></div>
    </div>
    
    <!-- QR Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

    <script>
        // Configuration
        const VIEWER_URL = 'https://clovenbradshaw-ctrl.github.io/safety/';
        const BEACON_TEXT = 'SQR:1';
        const WEBHOOK_URL = 'https://n8n.intelechia.com/webhook/d5e99c29-2cf1-44c1-b5b4-95a1ca048441';
        const ARCHIVE_BASE = 'https://archive.org/download/zuboff/';

        const LANGUAGE_NAMES = {
          en: 'English',
          es: 'Español',
          ar: 'العربية',
          ku: 'کوردی',
          vi: 'Tiếng Việt',
          zh: '中文',
          so: 'Soomaali',
          my: 'မြန်မာ',
          ne: 'नेपाली',
          am: 'አማርኛ',
          bn: 'বাংলা',
          de: 'Deutsch',
          el: 'Ελληνικά',
          fa: 'فارسی',
          fr: 'Français',
          gu: 'ગુજરાતી',
          he: 'עברית',
          hi: 'हिन्दी',
          ht: 'Kreyòl Ayisyen',
          it: 'Italiano',
          ja: '日本語',
          ko: '한국어',
          lo: 'ລາວ',
          pa: 'ਪੰਜਾਬੀ',
          pl: 'Polski',
          pt: 'Português',
          ru: 'Русский',
          sw: 'Kiswahili',
          ta: 'தமிழ்',
          te: 'తెలుగు',
          th: 'ไทย',
          tl: 'Tagalog',
          tr: 'Türkçe',
          uk: 'Українська',
          ur: 'اردو'
        };

        const PRIMARY_LANGS = ['en', 'es', 'ar', 'ku'];
        const RTL_LANGS = ['ar', 'ku', 'fa', 'he', 'ur'];

        let translations = {};

        let currentLanguage = 'en';

        function createLangButton(code) {
          const btn = document.createElement('button');
          btn.className = 'lang-btn';
          btn.dataset.lang = code;
          const span = document.createElement('span');
          span.className = 'lang-native';
          span.textContent = LANGUAGE_NAMES[code] || code;
          btn.appendChild(span);
          btn.addEventListener('click', () => setLanguage(code));
          return btn;
        }

        function buildLanguageButtons() {
          const primary = document.querySelector('.primary-languages');
          const secondary = document.querySelector('.secondary-languages');
          primary.innerHTML = '';
          secondary.innerHTML = '';

          PRIMARY_LANGS.forEach(code => {
            if (translations[code]) {
              primary.appendChild(createLangButton(code));
            }
          });

          Object.keys(translations)
            .filter(code => !PRIMARY_LANGS.includes(code))
            .forEach(code => {
              secondary.appendChild(createLangButton(code));
            });
        }

        function setLanguage(langCode) {
          currentLanguage = langCode;
          localStorage.setItem('preferredLanguage', langCode);

          const t = translations[langCode] || translations.en || {};
          document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (t[key]) el.textContent = t[key];
          });
          document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
            const key = el.getAttribute('data-i18n-placeholder');
            if (t[key]) el.placeholder = t[key];
          });

          document.body.classList.toggle('rtl', RTL_LANGS.includes(langCode));

          document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.lang === langCode);
          });
        }

        function toggleMoreLanguages() {
          const secondary = document.querySelector('.secondary-languages');
          const isVisible = secondary.style.display === 'grid';
          secondary.style.display = isVisible ? 'none' : 'grid';

          const plusIcon = document.querySelector('.plus-icon');
          plusIcon.textContent = isVisible ? '+' : '×';
        }

        // State
        let currentGUID = null;
        let currentKey = null;
        let currentData = null; // {id, data, auth}
        let currentBlob = null; // decrypted full data
        let currentMode = null;
        let currentCreated = null;
        let currentName = null;
        let ownerPassword = null;

        async function parseAndDisplay() {
            const hash = window.location.hash.substring(1);

            if (!hash) {
                currentMode = 'create';
                showCreationForm();
                return;
            }

            // Handle legacy format
            if (!hash.startsWith('v2:')) {
                return handleLegacyFormat(hash);
            }

            const [version, guid, key, embeddedStr] = hash.split(':');
            currentGUID = guid;
            currentKey = key;
            currentMode = 'view';
            const embedded = JSON.parse(atob(embeddedStr));

            // Show embedded data immediately
            displayBasicInfo({
                name: embedded.n,
                criticalInfo: embedded.c
            });

            // Attempt to load full data (non-blocking)
            fetch(`${ARCHIVE_BASE}${guid}.json`)
                .then(r => r.json())
                .then(async data => {
                    const full = JSON.parse(await decrypt(data.data, key));
                    displayFullInfo({
                        name: embedded.n,
                        criticalInfo: embedded.c,
                        publicInfo: full.publicInfo,
                        privateInfo: full.privateInfo
                    });
                })
                .catch(() => {
                    addOfflineNotice();
                });
        }

        function displayBasicInfo({ name, criticalInfo }) {
            const container = document.getElementById('main-content');
            container.innerHTML = `
                <div class="emergency-card">
                    <div class="emergency-header">
                        <h2><span class="info-icon">🚨</span><span data-i18n="emergencyInfo">EMERGENCY INFORMATION</span></h2>
                    </div>
                    <div class="content">
                        <div class="info-section">
                            <div class="info-item">
                                <span class="info-icon">👤</span>
                                <div class="info-content">
                                    <div class="info-label" data-i18n="name">Name</div>
                                    <div class="info-value">${name || 'Unknown'}</div>
                                </div>
                            </div>
                            ${criticalInfo ? `<div class="info-item"><span class="info-icon">⚠️</span><div class="info-content"><div class="info-label">Critical Info</div><div class="info-value">${criticalInfo}</div></div></div>` : ''}
                        </div>
                        <div class="status-message status-info" id="loading-message">Loading additional information...</div>
                    </div>
                </div>`;
            setLanguage(currentLanguage);
        }

        function displayFullInfo(full) {
            currentBlob = full;
            displayEmergencyInfo(full);
        }

        function addOfflineNotice() {
            const el = document.getElementById('loading-message');
            if (el) el.textContent = 'Additional information requires internet';
        }

        function handleLegacyFormat(hash) {
            const parts = hash.split('|');
            if (parts.length === 3) {
                const [guid, key, dataStr] = parts;
                loadEmergencyInfo(guid, key, dataStr);
            } else {
                currentMode = 'create';
                showCreationForm();
            }
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', async function() {
            try {
                const response = await fetch('translations.json');
                const data = await response.json();
                translations = data.translations || data;
            } catch (error) {
                console.error('Failed to load translations:', error);
            }

            buildLanguageButtons();

            const savedLang =
                localStorage.getItem('preferredLanguage') ||
                navigator.language.substring(0, 2) ||
                'en';
            setLanguage(savedLang);

            await parseAndDisplay();
        });

        async function loadEmergencyInfo(guid, key, permanentDataStr) {
            currentGUID = guid;
            currentKey = key;

            const permanentData = JSON.parse(atob(permanentDataStr));
            const displayData = {
                name: permanentData.n,
                bloodType: permanentData.b,
                allergies: permanentData.a,
                contact: (permanentData.cn || permanentData.cp)
                    ? { name: permanentData.cn || '', phone: permanentData.cp || '' }
                    : null
            };

            currentBlob = { publicInfo: displayData };
            await displayEmergencyInfo(currentBlob);

            try {
                const response = await fetch(`${ARCHIVE_BASE}${guid}.json`);
                if (response.ok) {
                    const archiveData = await response.json();
                    const decrypted = await decrypt(archiveData.editable, key);
                    const editableFields = JSON.parse(decrypted);

                    if (editableFields.bloodType) displayData.bloodType = displayData.bloodType || editableFields.bloodType;
                    if (editableFields.allergies) displayData.allergies = displayData.allergies || editableFields.allergies;
                    if (editableFields.contactName || editableFields.contactPhone) {
                        displayData.contact = displayData.contact || {};
                        if (editableFields.contactName) displayData.contact.name = editableFields.contactName;
                        if (editableFields.contactPhone) displayData.contact.phone = editableFields.contactPhone;
                    }
                    currentBlob.publicInfo = displayData;
                    await displayEmergencyInfo(currentBlob);
                }
            } catch (e) {
                console.log('Could not load editable fields', e);
            }
        }

        async function handleOfflineQR(data) {
            currentKey = data.k;
            const publicInfo = {
                name: data.n,
                bloodType: data.b,
                allergies: data.a,
                contact: data.c ? JSON.parse(atob(data.c)) : null
            };
            const privateInfo = data.p
                ? JSON.parse(await decrypt(data.p, data.k))
                : null;
            currentBlob = { publicInfo, privateInfo };
            await displayEmergencyInfo(currentBlob, {
                banner: '✅ Offline QR - No internet required'
            });
        }

        async function handleHybridQR(guid, key, embedded) {
            currentGUID = guid;
            currentKey = key;
            const publicInfo = {
                name: embedded.n,
                bloodType: embedded.b || 'Loading...',
                allergies: embedded.a || 'Loading...',
                contact: embedded.c
                    ? JSON.parse(atob(embedded.c))
                    : { name: 'Loading...', phone: 'Loading...' }
            };
            await displayEmergencyInfo(
                { publicInfo },
                {
                    banner:
                        '🔄 Hybrid mode - Critical data available, loading additional info...'
                }
            );
            try {
                const cloudData = await fetchFromArchive(guid, key);
                const merged = { ...cloudData };
                if (embedded.b) merged.publicInfo.bloodType = embedded.b;
                if (embedded.a) merged.publicInfo.allergies = embedded.a;
                if (embedded.c)
                    merged.publicInfo.contact = JSON.parse(atob(embedded.c));
                await displayEmergencyInfo(merged);
            } catch (error) {
                console.log('Cloud fetch failed, using embedded data only');
            }
        }

        async function handleCloudQR(parts) {
            const [guid, key, name, created] = parts.map(p => decodeURIComponent(p || ''));
            if (guid && key) {
                currentMode = 'view';
                currentCreated = created;
                currentName = name;
                showLoadingScreen(name);
                await loadAndDisplayEmergencyInfo(guid, key, name, created);
            } else {
                currentMode = 'create';
                showCreationForm();
            }
        }

        async function fetchFromArchive(guid, key) {
            const archiveUrl = `${ARCHIVE_BASE}${guid}.json`;
            const response = await fetch(archiveUrl, { mode: 'cors' });
            if (!response.ok) throw new Error('Not found');
            const data = await response.json();
            const decrypted = await decrypt(data.data, key);
            const fullData = JSON.parse(decrypted);
            currentData = data;
            currentBlob = { ...fullData };
            return currentBlob;
        }
        
        // Show loading screen
        function showLoadingScreen(name) {
            const container = document.getElementById('main-content');
            container.innerHTML = `
                <div class="loading-screen">
                    <div class="spinner"></div>
                    <p>Loading emergency information${name ? ` for ${name}` : ''}...</p>
                </div>
            `;
        }
        
        // Load and display emergency info
        async function loadAndDisplayEmergencyInfo(guid, key, urlName, created) {
            currentGUID = guid;
            currentKey = key;

            console.log('Loading emergency info for:', guid);
            console.log('Created timestamp:', created);

            const createdTime = created ? new Date(decodeURIComponent(created)) : null;
            let banner = null;
            let data;
            let fetchSuccess = false;

            // Calculate age of QR code
            if (createdTime) {
                const ageMinutes = (Date.now() - createdTime.getTime()) / 60000;
                console.log('QR code age in minutes:', ageMinutes);

                if (ageMinutes < 5) {
                    banner = '⏳ Data still uploading to backup servers (usually takes 5-30 minutes). QR code works locally in the meantime.';
                } else if (ageMinutes < 30) {
                    banner = '⏳ Data may still be uploading to backup servers. If not loading, please wait a few more minutes.';
                }
            }

            try {
                // Try to fetch from Archive.org
                const archiveUrl = `${ARCHIVE_BASE}${guid}.json`;
                console.log('Fetching from Archive.org:', archiveUrl);

                const response = await fetch(archiveUrl, { mode: 'cors' });
                console.log('Archive.org response status:', response.status);

                if (response.ok) {
                    data = await response.json();
                    fetchSuccess = true;
                    console.log('Successfully loaded from Archive.org');
                } else {
                    throw new Error('Not found on Archive.org');
                }
            } catch (error) {
                console.log('Archive fetch failed:', error.message);

                // Check local storage fallback
                const localData = localStorage.getItem('pending_' + guid);
                if (localData) {
                    console.log('Found local fallback data');
                    const parsed = JSON.parse(localData);
                    data = { local: true, full: parsed };
                }
            }

            if (!fetchSuccess && createdTime) {
                const ageMinutes = (Date.now() - createdTime.getTime()) / 60000;
                if (ageMinutes < 5) {
                    banner = '⏳ Data uploading to Archive.org - this usually takes 5-30 minutes. Your QR works locally for now!';
                } else if (ageMinutes < 30) {
                    banner = '⏳ Data may still be uploading - Archive.org backup can take up to 30 minutes to complete';
                } else {
                    banner = '⚠️ Data not found on Archive.org - backup may have failed. Try re-uploading.';
                }
            }

            if (!data) {
                await displayEmergencyInfo({ publicInfo: { name: urlName || 'Unknown' } }, { overrideName: urlName, banner });
                return;
            }

            try {
                let fullData;
                if (data.local) {
                    fullData = data.full;
                } else {
                    const decrypted = await decrypt(data.data, key);
                    fullData = JSON.parse(decrypted);
                }

                // Validate beacon
                if (fullData.beacon !== BEACON_TEXT) {
                    throw new Error('Invalid QR code');
                }

                currentData = data;
                currentBlob = { ...fullData };

                await displayEmergencyInfo(fullData, { overrideName: urlName, banner });
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Unable to load emergency information. Please check the QR code.');
            }
        }

        // Display emergency information
        async function displayEmergencyInfo(fullData, options = {}) {
            const container = document.getElementById('main-content');

            const publicInfo = fullData.publicInfo || {};
            const nameToShow = options.overrideName || fullData.name || publicInfo.name || 'Unknown';

            let html = `
                <div class="emergency-card">
                    <div class="emergency-header">
                        <h2><span class="info-icon">🚨</span><span data-i18n="emergencyInfo">EMERGENCY INFORMATION</span></h2>
                    </div>
                    ${options.banner ? `<div class="status-message status-info">${options.banner}</div>` : ''}

                    <div class="content">
                        <div class="info-section">
                            <div class="info-item">
                                <span class="info-icon">👤</span>
                                <div class="info-content">
                                    <div class="info-label" data-i18n="name">Name</div>
                                    <div class="info-value">${nameToShow}</div>
                                </div>
                            </div>
            `;

            if (fullData.criticalInfo) {
                html += `
                            <div class="info-item">
                                <span class="info-icon">⚠️</span>
                                <div class="info-content">
                                    <div class="info-label">Critical Info</div>
                                    <div class="info-value">${fullData.criticalInfo}</div>
                                </div>
                            </div>
                `;
            }
            
            if (publicInfo.bloodType) {
                html += `
                            <div class="info-item">
                                <span class="info-icon">🩸</span>
                                <div class="info-content">
                                    <div class="info-label" data-i18n="bloodType">Blood Type</div>
                                    <div class="info-value">${publicInfo.bloodType}</div>
                                </div>
                            </div>
                `;
            }
            
            if (publicInfo.allergies) {
                html += `
                            <div class="info-item">
                                <span class="info-icon">⚠️</span>
                                <div class="info-content">
                                    <div class="info-label" data-i18n="allergies">Allergies</div>
                                    <div class="info-value">${publicInfo.allergies}</div>
                                </div>
                            </div>
                `;
            }
            
            html += `</div>`;
            
            if (publicInfo.contact) {
                html += `
                        <div class="info-section">
                            <div class="info-item">
                                <span class="info-icon">📞</span>
                                <div class="info-content">
                                    <div class="info-label" data-i18n="emergencyContact">Emergency Contact</div>
                                    <div class="info-value">
                                        ${publicInfo.contact.name}
                                        <a href="tel:${publicInfo.contact.phone}" class="phone-link">
                                            📱 ${publicInfo.contact.phone}
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                `;
            }
            
            if (currentBlob && currentBlob.privateInfo) {
                html += `
                        <div class="private-section">
                            <h3><span class="info-icon">🔒</span><span data-i18n="privateInfo">Private Information</span></h3>
                            <input type="password" class="password-input" id="vault-password" data-i18n-placeholder="enterPassword" placeholder="Enter password">
                            <button class="btn" onclick="unlockPrivateInfo()" data-i18n="unlock">Unlock</button>
                            <div id="private-content"></div>
                        </div>
                `;
            }
            
            html += `
                        <div class="help-link">
                            <button class="btn-outline" style="font-size:12px;padding:4px 8px;" onclick="ownerLogin()">Owner Login</button>
                            <a href="#" onclick="toggleHelp(); return false;">How It Works</a>
                            <div id="help-content" class="help-content"></div>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            setLanguage(currentLanguage);

            // Allow pressing Enter to unlock private information
            const passwordInput = document.getElementById('vault-password');
            if (passwordInput) {
                passwordInput.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        unlockPrivateInfo();
                    }
                });
            }
        }
        
        // Unlock private information
        async function unlockPrivateInfo() {
            const password = document.getElementById('vault-password').value;
            if (!password) return;

            try {
                const hash = await sha256Hash(currentKey + password);
                if (!currentBlob.privateInfo || hash !== currentBlob.privateInfo.encryptedWith) {
                    throw new Error('Incorrect password');
                }
                ownerPassword = password;

                const privateInfo = currentBlob.privateInfo;
                let html = '<div style="margin-top: 15px;">';

                if (privateInfo.ssn) {
                    html += `
                        <div class="info-item">
                            <span class="info-icon">🆔</span>
                            <div class="info-content">
                                <div class="info-label">SSN</div>
                                <div class="info-value">${privateInfo.ssn}</div>
                            </div>
                        </div>
                    `;
                }

                if (privateInfo.notes) {
                    html += `
                        <div class="info-item">
                            <span class="info-icon">📝</span>
                            <div class="info-content">
                                <div class="info-label">Medical Notes</div>
                                <div class="info-value">${privateInfo.notes}</div>
                            </div>
                        </div>
                    `;
                }

                html += '</div>';

                document.getElementById('private-content').innerHTML = html;
                document.getElementById('vault-password').style.display = 'none';
                document.querySelector('.private-section button').style.display = 'none';

            } catch (error) {
                alert('Incorrect password');
            }
        }

        function ownerLogin() {
            const password = ownerPassword || document.getElementById('vault-password')?.value;
            if (!password) {
                alert('Please enter your password to update this emergency QR.');
                return;
            }
            showUpdateForm(password);
        }

        async function showUpdateForm(password) {
            try {
                // Retrieve stored auth
                let originalAuth = localStorage.getItem(`auth_${currentGUID}`);

                if (!originalAuth) {
                    // Fallback: fetch from Archive
                    const response = await fetch(`${ARCHIVE_BASE}${currentGUID}.json`);
                    if (response.ok) {
                        const data = await response.json();
                        originalAuth = data.auth;
                        localStorage.setItem(`auth_${currentGUID}`, originalAuth);
                    }
                }

                if (!originalAuth) {
                    throw new Error("Cannot retrieve authentication data");
                }

                // Generate update token
                const updateToken = await generateUpdateToken(password, currentGUID);

                // Verify it matches
                const testAuth = await sha256Hash(updateToken);
                if (testAuth !== originalAuth) {
                    throw new Error("Password verification failed");
                }

                // Continue with form setup...

                // Show update form (reuse creation form with pre-filled data)
                showCreationForm();

                // Pre-fill form with current data
                const publicInfo = currentBlob.publicInfo || {};

                document.getElementById('name').value = currentBlob.name || publicInfo.name || '';
                document.getElementById('name').disabled = true;
                document.getElementById('critical-info').value = currentBlob.criticalInfo || '';
                document.getElementById('critical-info').disabled = true;
                document.querySelector('#critical-info + .field-info .char-counter').textContent = `${(currentBlob.criticalInfo || '').length}/100`;
                document.getElementById('blood-type').value = publicInfo.bloodType || '';
                document.getElementById('allergies').value = publicInfo.allergies || '';
                document.getElementById('contact-name').value = publicInfo.contact?.name || '';
                document.getElementById('contact-phone').value = publicInfo.contact?.phone || '';

                if (currentBlob.privateInfo) {
                    const privateInfo = currentBlob.privateInfo;
                    document.getElementById('ssn').value = privateInfo.ssn || '';
                    document.getElementById('medical-notes').value = privateInfo.notes || '';
                }

                // Change form handler to update instead of create
                document.getElementById('create-form').removeEventListener('submit', handleCreateForm);
                document.getElementById('create-form').addEventListener('submit', (e) => handleUpdateForm(e, password));

                // Change button text
                document.querySelector('#create-form button[type="submit"]').innerHTML = '<span>Update QR</span>';

            } catch (error) {
                console.error('Update error:', error);
                alert('Failed to prepare update: ' + error.message);
            }
        }

        async function handleUpdateForm(e, password) {
            e.preventDefault();

            const button = e.target.querySelector('button[type="submit"]');
            button.disabled = true;
            button.innerHTML = '<span>Updating...</span>';

            try {
                // Generate update token and auth
                const updateToken = await generateUpdateToken(password, currentGUID);
                const auth = await sha256Hash(updateToken);

                // Collect updated form data
                const publicInfo = {
                    bloodType: document.getElementById('blood-type').value,
                    allergies: document.getElementById('allergies').value,
                    contact: {
                        name: document.getElementById('contact-name').value,
                        phone: document.getElementById('contact-phone').value
                    }
                };

                const privateInfo = password ? {
                    ssn: document.getElementById('ssn').value,
                    notes: document.getElementById('medical-notes').value,
                    encryptedWith: await sha256Hash(currentKey + password)
                } : null;

                const payload = { publicInfo, privateInfo };
                const encryptedBlob = await encrypt(JSON.stringify(payload), currentKey);

                const updatePayload = {
                    guid: currentGUID,
                    auth: auth,  // Send unencrypted for verification
                    data: encryptedBlob,  // New encrypted data
                    metadata: {
                        updated: new Date().toISOString()
                    }
                };

                const response = await fetch(WEBHOOK_URL, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatePayload)
                });

                if (response.status === 403) {
                    throw new Error('Invalid password - update denied');
                }
                if (!response.ok) {
                    throw new Error('Update failed');
                }

                currentData = { id: currentGUID, data: encryptedBlob, auth };
                currentBlob = { ...currentBlob, publicInfo, privateInfo };
                showStatus('✅ Successfully updated!', 'success');

                // Show the updated QR view
                await displayFullInfo(currentBlob);

            } catch (error) {
                showStatus('Error: ' + error.message, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = '<span>Update QR</span>';
            }
        }
        
        // Show creation form
        function showCreationForm() {
            currentMode = 'create';
            const container = document.getElementById('main-content');

            container.innerHTML = `
                <div class="header">
                    <h1 data-i18n="createYourEmergencyQR">Create Your Emergency QR</h1>
                    <p data-i18n="emergencyQRTagline">Your emergency QR: Public enough to save your life, private enough to protect your identity</p>
                </div>

                <div class="content">
                      <form id="create-form">
                          <div class="section-title" data-i18n="emergencyInfo">Emergency Information</div>

                          <div class="form-group">
                              <label for="name"><span data-i18n="name">Name</span> *</label>
                              <input type="text" id="name" required placeholder="John Doe" data-i18n-placeholder="contactNamePlaceholder">
                          </div>

                          <div class="form-group">
                              <label for="critical-info"><span data-i18n="criticalInfo">Critical Information</span> (<span data-i18n="optional">Optional</span>)</label>
                              <textarea
                                  id="critical-info"
                                  maxlength="100"
                                  rows="2"
                                  data-i18n-placeholder="criticalInfoPlaceholder"
                                  placeholder="e.g., Severe penicillin allergy, Type 1 diabetic"
                              ></textarea>
                              <div class="field-info">
                                  <span class="char-counter">0/100</span>
                                  <span class="info-note" data-i18n="criticalInfoNote">• Embedded in QR • Always visible</span>
                              </div>
                          </div>

                          <div class="form-group">
                              <label for="blood-type" data-i18n="bloodType">Blood Type</label>
                              <select id="blood-type">
                                  <option value="" data-i18n="unknown">Unknown</option>
                                  <option value="A+">A+</option>
                                  <option value="A-">A-</option>
                                  <option value="B+">B+</option>
                                  <option value="B-">B-</option>
                                  <option value="AB+">AB+</option>
                                  <option value="AB-">AB-</option>
                                  <option value="O+">O+</option>
                                  <option value="O-">O-</option>
                              </select>
                          </div>

                          <div class="form-group">
                              <label for="allergies" data-i18n="allergies">Allergies</label>
                              <textarea id="allergies" placeholder="Penicillin, peanuts, etc." data-i18n-placeholder="allergiesPlaceholder"></textarea>
                          </div>

                          <div class="form-group">
                              <label for="contact-name"><span data-i18n="emergencyContactName">Emergency Contact Name</span> *</label>
                              <input type="text" id="contact-name" required placeholder="Jane Doe" data-i18n-placeholder="contactNamePlaceholder">
                          </div>

                          <div class="form-group">
                              <label for="contact-phone"><span data-i18n="emergencyContactPhone">Emergency Contact Phone</span> *</label>
                              <input type="tel" id="contact-phone" required placeholder="(555) 123-4567" data-i18n-placeholder="contactPhonePlaceholder">
                          </div>

                          <div class="section-title" data-i18n="passwordProtected">Password Protected</div>

                          <div class="form-group">
                              <label for="ssn"><span data-i18n="ssn">Social Security Number</span></label>
                              <input type="text" id="ssn" placeholder="XXX-XX-XXXX" data-i18n-placeholder="ssnPlaceholder">
                          </div>

                          <div class="form-group">
                              <label for="medical-notes"><span data-i18n="medicalNotes">Medical Notes</span></label>
                              <textarea id="medical-notes" placeholder="Medications, conditions, etc." data-i18n-placeholder="medicalNotesPlaceholder"></textarea>
                          </div>

                        <div class="form-group">
                            <label for="password"><span data-i18n="password">Password</span> *</label>
                            <input type="password" id="password" required placeholder="Choose a password" data-i18n-placeholder="choosePassword">
                            <div id="password-strength" class="hint"></div>
                        </div>

                        <div class="form-group">
                            <label for="password-confirm"><span data-i18n="confirmPassword">Confirm Password</span> *</label>
                            <input type="password" id="password-confirm" required placeholder="Re-enter password" data-i18n-placeholder="reenterPassword">
                        </div>

                        <div class="hint" id="password-req" data-i18n="passwordRequirements">
                            Password must be 8+ chars with upper, lower, number and special character.
                        </div>

                        <div class="hint">
                            Be sure to store this password if you want to update this, otherwise you will need to create a new one and the data is unchangable and the data that is password protected will be lost forever.
                        </div>

                        <button type="submit" class="btn">
                            <span data-i18n="createQR">Create QR</span>
                        </button>
                    </form>

                    <div id="qr-result" style="display: none;">
                        <div class="qr-display">
                            <h3>✅ Your Emergency QR Code</h3>
                            <p style="color: #666; font-size: 14px; margin: 10px 0;">
                                ✓ Encrypted with zero-knowledge security<br>
                                ✓ Backed up to Archive.org<br>
                                ✓ Only this QR can decrypt your data
                            </p>
                            <div id="qrcode"></div>
                            <div class="action-buttons">
                                <button class="btn" onclick="downloadQR()">💾 <span data-i18n="download">Download</span></button>
                                <button class="btn" onclick="testQR()">🔍 <span data-i18n="test">Test</span></button>
                            </div>
                            <div class="status-message status-info" style="margin-top: 15px;">
                                <strong>Important:</strong> Save this QR code! It contains the only key to your data.
                            </div>
                        </div>
                    </div>

                    <div id="status-message"></div>

                    <div class="help-link">
                        <a href="#" onclick="toggleHelp(); return false;">How It Works</a>
                        <div id="help-content" class="help-content"></div>
                    </div>
                </div>
            `;

            setLanguage(currentLanguage);

            // Add form submit handler
            document.getElementById('create-form').addEventListener('submit', handleCreateForm);

            // Password strength meter
            document.getElementById('password').addEventListener('input', () => {
                const pwd = document.getElementById('password').value;
                const strengthEl = document.getElementById('password-strength');
                strengthEl.textContent = isStrongPassword(pwd) ? '✅ Meets requirements' : '❌ Does not meet requirements';
            });

            // Critical info character counter
            const ci = document.getElementById('critical-info');
            const counter = ci.parentElement.querySelector('.char-counter');
            ci.addEventListener('input', () => {
                counter.textContent = `${ci.value.length}/100`;
            });
        }

        // Handle form submission
        async function handleCreateForm(e) {
            e.preventDefault();

            const button = e.target.querySelector('button[type="submit"]');
            button.disabled = true;
            button.innerHTML = '<span>Creating & Securing...</span>';

            try {
                const password = document.getElementById('password').value;
                const confirmPassword = document.getElementById('password-confirm').value;

                if (!password) {
                    throw new Error('Password is required');
                }
                if (!isStrongPassword(password)) {
                    throw new Error('Password does not meet requirements');
                }
                if (password !== confirmPassword) {
                    throw new Error('Passwords do not match');
                }

                // Generate identifiers and keys
                currentGUID = generateGUID();
                currentKey = generateKey();
                const created = new Date().toISOString();

                // Collect form data
                const formData = {
                    name: document.getElementById('name').value,
                    criticalInfo: document.getElementById('critical-info').value,
                    bloodType: document.getElementById('blood-type').value,
                    allergies: document.getElementById('allergies').value,
                    contactName: document.getElementById('contact-name').value,
                    contactPhone: document.getElementById('contact-phone').value,
                    ssn: document.getElementById('ssn').value,
                    notes: document.getElementById('medical-notes').value,
                    passwordHint: document.getElementById('password-hint')?.value || ''
                };

                // Create auth hash
                const updateToken = await generateUpdateToken(password, currentGUID);
                const auth = await sha256Hash(updateToken);

                // Prepare encrypted data
                const publicInfo = {
                    bloodType: formData.bloodType,
                    allergies: formData.allergies,
                    contact: { name: formData.contactName, phone: formData.contactPhone }
                };

                const privateInfo = password ? {
                    ssn: formData.ssn,
                    notes: formData.notes,
                    encryptedWith: await sha256Hash(currentKey + password)
                } : null;

                const payload = { publicInfo, privateInfo, passwordHint: formData.passwordHint };
                const encryptedData = await encrypt(JSON.stringify(payload), currentKey);

                // Create data package
                currentData = {
                    id: currentGUID,
                    data: encryptedData,
                    auth: auth
                };

                // IMMEDIATELY upload to server
                showStatus('⏳ Securing your data online...', 'info');

                // Send to server with UNENCRYPTED auth hash
                const serverPayload = {
                    guid: currentGUID,
                    data: encryptedData,
                    auth: auth,
                    metadata: {
                        created: created,
                        type: 'emergency_qr',
                        version: 'v2'
                    }
                };

                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(serverPayload)
                });

                if (!response.ok) {
                    throw new Error('Failed to secure data online');
                }

                // Store auth for future updates
                localStorage.setItem(`auth_${currentGUID}`, auth);

                // Only generate QR after successful upload
                const embedded = btoa(JSON.stringify({
                    n: formData.name,
                    c: formData.criticalInfo?.substring(0, 100)
                }));

                const qrUrl = `${VIEWER_URL}#v2:${currentGUID}:${currentKey}:${embedded}`;

                // Generate QR code
                const qrContainer = document.getElementById('qrcode');
                qrContainer.innerHTML = '';
                new QRCode(qrContainer, {
                    text: qrUrl,
                    width: 256,
                    height: 256,
                    correctLevel: QRCode.CorrectLevel.H
                });

                window.currentQRUrl = qrUrl;

                currentBlob = { version: 'v2', created, name: formData.name, criticalInfo: formData.criticalInfo, publicInfo, privateInfo };

                // Show success
                document.getElementById('create-form').style.display = 'none';
                document.getElementById('qr-result').style.display = 'block';
                showStatus('✅ QR code created and backed up online!', 'success');

            } catch (error) {
                showStatus('Error: ' + error.message, 'error');
                // Don't create QR if upload failed
            } finally {
                button.disabled = false;
                button.innerHTML = '<span data-i18n="createQR">Create QR</span>';
                setLanguage(currentLanguage);
            }
        }


        // Utility functions
        function generateGUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        function generateKey(length = 32) {
            const array = new Uint8Array(length);
            crypto.getRandomValues(array);
            return btoa(String.fromCharCode.apply(null, array))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        function isStrongPassword(pwd) {
            return /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^A-Za-z0-9]).{8,}$/.test(pwd);
        }
        
        async function encrypt(text, password) {
            const enc = new TextEncoder();
            const salt = crypto.getRandomValues(new Uint8Array(16));
            const iv = crypto.getRandomValues(new Uint8Array(12));
            
            const passwordKey = await crypto.subtle.importKey(
                "raw",
                enc.encode(password),
                "PBKDF2",
                false,
                ["deriveBits", "deriveKey"]
            );
            
            const aesKey = await crypto.subtle.deriveKey(
                {
                    name: "PBKDF2",
                    salt: salt,
                    iterations: 100000,
                    hash: "SHA-256"
                },
                passwordKey,
                { 
                    name: "AES-GCM",
                    length: 256
                },
                false,
                ["encrypt"]
            );
            
            const encrypted = await crypto.subtle.encrypt(
                { 
                    name: "AES-GCM",
                    iv: iv,
                    tagLength: 128
                },
                aesKey,
                enc.encode(text)
            );
            
            const encryptedContent = new Uint8Array(encrypted);
            const buf = new Uint8Array(salt.byteLength + iv.byteLength + encryptedContent.byteLength);
            buf.set(salt, 0);
            buf.set(iv, salt.byteLength);
            buf.set(encryptedContent, salt.byteLength + iv.byteLength);
            
            return btoa(String.fromCharCode(...buf));
        }
        
        async function decrypt(encryptedData, password) {
            const enc = new TextEncoder();
            const dec = new TextDecoder();
            
            const data = Uint8Array.from(atob(encryptedData), c => c.charCodeAt(0));
            const salt = data.slice(0, 16);
            const iv = data.slice(16, 28);
            const encrypted = data.slice(28);
            
            const passwordKey = await crypto.subtle.importKey(
                "raw",
                enc.encode(password),
                "PBKDF2",
                false,
                ["deriveBits", "deriveKey"]
            );
            
            const aesKey = await crypto.subtle.deriveKey(
                {
                    name: "PBKDF2",
                    salt: salt,
                    iterations: 100000,
                    hash: "SHA-256"
                },
                passwordKey,
                { 
                    name: "AES-GCM",
                    length: 256
                },
                false,
                ["decrypt"]
            );
            
            const decrypted = await crypto.subtle.decrypt(
                { 
                    name: "AES-GCM",
                    iv: iv,
                    tagLength: 128
                },
                aesKey,
                encrypted
            );
            
            return dec.decode(decrypted);
        }

        async function generateUpdateToken(password, guid) {
            // Deterministic token from password + guid
            const encoder = new TextEncoder();
            const data = encoder.encode(password + guid + "UPDATE_SALT_V1");
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode(...new Uint8Array(hashBuffer)))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        async function sha256Hash(text) {
            const encoder = new TextEncoder();
            const data = encoder.encode(text);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function createDemoData(guid, key) {
            const fullData = {
                version: "2.0",
                created: new Date().toISOString(),
                beacon: BEACON_TEXT,
                publicInfo: {
                    name: "Demo User",
                    bloodType: "O+",
                    allergies: "Penicillin, Peanuts",
                    contact: {
                        name: "Emergency Contact",
                        phone: "(555) 123-4567"
                    }
                },
                privateInfo: {
                    ssn: "XXX-XX-XXXX",
                    notes: "This is demo data. Password is: demo",
                    encryptedWith: await sha256Hash(key + "demo")
                }
            };

            const encryptedBlob = await encrypt(JSON.stringify(fullData), key);
            const updateToken = await generateUpdateToken("demo", guid);
            return {
                id: guid,
                data: encryptedBlob,
                auth: await sha256Hash(updateToken)
            };
        }

        function downloadQR() {
            const canvas = document.querySelector('#qrcode canvas');
            if (canvas) {
                const link = document.createElement('a');
                link.download = 'emergency-qr.png';
                link.href = canvas.toDataURL();
                link.click();
            }
        }
        
        function testQR() {
            if (window.currentQRUrl) {
                window.open(window.currentQRUrl, '_blank');
            }
        }
        
        function showStatus(message, type) {
            const element = document.getElementById('status-message');
            if (!element) return;
            
            element.className = 'status-message status-' + type;
            element.textContent = message;
            element.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    element.style.display = 'none';
                }, 5000);
            }
        }
        
        function showError(message) {
            const container = document.getElementById('main-content');
            container.innerHTML = `
                <div class="header">
                    <h1>❌ Error</h1>
                </div>
                <div class="content">
                    <div class="status-message status-error">
                        ${message}
                    </div>
                    <button class="btn" onclick="showCreationForm()">Create New QR</button>
                </div>
            `;
        }
        
        function toggleHelp() {
            const helpContent = document.getElementById('help-content');
            if (!helpContent) return;
            
            if (helpContent.classList.contains('active')) {
                helpContent.classList.remove('active');
            } else {
                helpContent.innerHTML = `
                    <h4>How Your Privacy Works</h4>
                    <p>Anyone who scans your QR sees:</p>
                    <ul>
                        <li>✓ Your name & emergency contact (that's the point - to help you!)</li>
                        <li>✓ Blood type & allergies (critical for first responders)</li>
                    </ul>
                    <p>Only with your password:</p>
                    <ul>
                        <li>🔒 Social Security Number</li>
                        <li>🔒 Medical notes & medications</li>
                    </ul>
                    <p><strong>The Beautiful Math:</strong><br>
                    Your encryption has more possible combinations than there are<br>
                    grains of sand on all beaches on Earth... multiplied by the<br>
                    number of stars in the universe... multiplied by a trillion.</p>
                    <p><strong>Important:</strong> We designed this so even WE can't access your data.<br>
                    Your QR code contains the only encryption key that exists.<br>
                    Lose the QR = lose access forever. There's no password reset,<br>
                    no customer service that can help, no backdoor.</p>
                    <p>This is true security - not even the creators can break in.</p>
                `;
                helpContent.classList.add('active');
            }
        }
        
        // Dev Tools Functions
        function toggleDevTools() {
            const panel = document.getElementById('dev-panel');
            panel.classList.toggle('active');
        }
        
        async function devLoadQR() {
            const guid = document.getElementById('dev-guid').value;
            const key = document.getElementById('dev-key').value;
            
            if (!guid || !key) {
                document.getElementById('dev-output').textContent = 'Please enter both GUID and Key';
                return;
            }
            
            document.getElementById('dev-output').textContent = 'Loading...';
            
            try {
                await loadAndDisplayEmergencyInfo(guid, key, null, null);
                document.getElementById('dev-output').textContent = 'Successfully loaded QR data';
            } catch (error) {
                document.getElementById('dev-output').textContent = 'Error: ' + error.message;
            }
        }
        
        async function devTestArchive() {
            const guid = document.getElementById('dev-guid').value;
            if (!guid) {
                document.getElementById('dev-output').textContent = 'Please enter a GUID';
                return;
            }
            
            const archiveUrl = `${ARCHIVE_BASE}${guid}.json`;
            document.getElementById('dev-output').textContent = `Testing: ${archiveUrl}\n\nFetching...`;
            
            try {
                const response = await fetch(archiveUrl, { mode: 'cors' });
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('dev-output').textContent =
                        `Success! Found on Archive.org\n\n` +
                        `ID: ${data.id}\n` +
                        `Has Auth: ${!!data.auth}\n\n` +
                        `Raw JSON:\n${JSON.stringify(data, null, 2)}`;
                } else {
                    document.getElementById('dev-output').textContent = 
                        `Not found on Archive.org (${response.status})\n\n` +
                        `This GUID may not have been uploaded yet.`;
                }
            } catch (error) {
                document.getElementById('dev-output').textContent = 
                    `Fetch error: ${error.message}\n\n` +
                    `This could be a CORS issue or network problem.`;
            }
        }
        
        async function devScanQR() {
            const file = document.getElementById('dev-qr-upload').files[0];
            const output = document.getElementById('dev-output');
            if (!file) {
                output.textContent = 'Please select a QR image file';
                return;
            }

            output.textContent = 'Scanning QR image...';
            try {
                const data = await scanFileForQR(file);
                if (!data) {
                    output.textContent = 'Unable to read QR code from image';
                    return;
                }

                output.textContent = `QR detected: ${data}`;
                const { guid, key } = parseQRData(data);
                await loadAndDisplayEmergencyInfo(guid, key, null, null);
                output.textContent += '\nLoaded QR data';
            } catch (error) {
                output.textContent = 'Error: ' + error.message;
            }
        }

        function parseQRData(text) {
            let guid, key;
            if (text.includes('v2:')) {
                const hash = text.split('#')[1];
                const parts = hash.split(':');
                guid = parts[1];
                key = parts[2];
            } else if (text.includes('http')) {
                const parts = text.split('#');
                const url = new URL(parts[0]);
                guid = url.searchParams.get('guid');
                key = parts[1];
            } else if (text.includes('#')) {
                [guid, key] = text.split('#');
            }
            if (!guid || !key) {
                throw new Error('Invalid QR data');
            }
            return { guid, key };
        }

        function scanFileForQR(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const code = jsQR(imageData.data, canvas.width, canvas.height);
                        resolve(code ? code.data : null);
                    };
                    img.onerror = () => reject(new Error('Invalid image')); 
                    img.src = reader.result;
                };
                reader.onerror = () => reject(new Error('File reading failed'));
                reader.readAsDataURL(file);
            });
        }
        
        function devShowRawData() {
            if (!currentData) {
                document.getElementById('dev-output').textContent = 'No data loaded';
                return;
            }
            
            document.getElementById('dev-output').textContent = 
                `Current Data:\n\n` +
                `GUID: ${currentGUID}\n` +
                `Key: ${currentKey}\n` +
                `Mode: ${currentMode}\n\n` +
                `Raw Data:\n${JSON.stringify(currentData, null, 2)}`;
        }
        
        function devClearStorage() {
            currentGUID = null;
            currentKey = null;
            currentData = null;
            document.getElementById('dev-output').textContent = 'All data cleared';
        }

        // Allow closing dev tools
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.getElementById('dev-panel').classList.remove('active');
            }
        });

        document.addEventListener('click', function(e) {
            const panel = document.getElementById('dev-panel');
            if (panel.classList.contains('active') &&
                !e.target.closest('.dev-panel') &&
                !e.target.closest('.dev-trigger')) {
                panel.classList.remove('active');
            }
        });

        // Triple-click to show dev tools
        let clickCount = 0;
        let clickTimer = null;
        
        document.addEventListener('click', function(e) {
            if (e.target.closest('.dev-trigger') || e.target.closest('.dev-panel')) return;
            
            clickCount++;
            
            if (clickCount === 3) {
                document.querySelector('.dev-trigger').style.opacity = '1';
                clickCount = 0;
            }
            
            clearTimeout(clickTimer);
            clickTimer = setTimeout(() => {
                clickCount = 0;
            }, 500);
        });
    </script>
</body>
</html>
